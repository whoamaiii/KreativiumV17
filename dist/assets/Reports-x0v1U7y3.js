const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/exportSystem-Cd06BMud.js","assets/vendor-utils-BNQKEpbf.js"])))=>i.map(i=>d[i]);
import{_ as ee}from"./3d-DUDogAyU.js";import{j as e}from"./vendor-ui-BGGfvU-n.js";import{a as i,u as te}from"./vendor-react-BiKKw5Rc.js";import{u as se,k as M,J as F,C as re,b as ae,B as R}from"./index-p40y1I9K.js";import{d as O}from"./dataStorage-ZXqbZ8jG.js";import{l as I}from"./logger-Bi5o39IC.js";import{B as ne}from"./Breadcrumbs-LYkGWA_d.js";import{S as J,a as V,b as U,c as W,d as E}from"./select-Df25Jq5p.js";import{C as q}from"./checkbox-wCMB9JkF.js";import{L as C}from"./label-DPtwVyR_.js";import{D as oe}from"./download-B5AHGw6a.js";import{F as ie}from"./file-text-x8qZG1DU.js";import{S as le}from"./save-C79c2pc2.js";import"./vendor-utils-BNQKEpbf.js";import"./i18n-DNqVcHxj.js";import"./storageUtils-DyonkL-b.js";import"./check-JkTn6zF0.js";function ce(a){return new Worker("/reports.worker.BEYAd7WI.worker.js",{type:"module",name:a?.name})}function de(){const a=i.useRef(null),r=i.useRef(new Map);return i.useEffect(()=>{const n=new ce,m=r.current;return n.onmessage=u=>{const o=u.data;if(!o)return;const j=r.current.get(o.id);j&&(o.type==="progress"?j.onProgress?.({progress:o.progress,message:o.message}):o.type==="success"?(r.current.delete(o.id),j.resolve(o.content)):o.type==="error"&&(r.current.delete(o.id),j.reject(new Error(o.error))))},n.onerror=()=>{m.forEach((u,o)=>{try{u.reject(new Error("Reports worker error"))}catch{}m.delete(o)})},a.current=n,()=>{m.forEach((u,o)=>{try{u.reject(new Error("Reports worker terminated"))}catch{}m.delete(o)}),n.terminate(),a.current=null}},[]),{run:i.useCallback(async n=>{if(!a.current)throw new Error("Reports worker not initialized");const m=`${Date.now()}_${Math.random().toString(36).slice(2)}`;return new Promise((u,o)=>{r.current.set(m,{resolve:u,reject:o,onProgress:n.onProgress});const j={id:m,kind:n.kind,payload:{students:n.students,allData:n.allData,options:{format:n.kind,includeFields:n.options.includeFields,anonymize:n.options.anonymize,dateRange:n.options.dateRange?{start:n.options.dateRange.start.toISOString(),end:n.options.dateRange.end.toISOString()}:null}}};a.current.postMessage(j)})},[])}}const L="sensory-tracker_export_prefs_v1",Ce=()=>{const{tSettings:a,tCommon:r}=se(),[y,n]=i.useState(!1),[m,u]=i.useState(0),{run:o}=de(),j=te(),[c,B]=i.useState("all"),[x,T]=i.useState(""),[g,$]=i.useState(""),[f,z]=i.useState(!1),[_,A]=i.useState(!1);i.useEffect(()=>{try{const t=localStorage.getItem(L);if(t){const s=JSON.parse(t);B(s.preset??"all"),T(s.customStart??""),$(s.customEnd??""),z(!!s.anonymize),A(!!s.backupUseFilters)}}catch{}},[]),i.useEffect(()=>{try{localStorage.setItem(L,JSON.stringify({preset:c,customStart:x,customEnd:g,anonymize:f,backupUseFilters:_}))}catch{}},[c,x,g,f,_]);const p=i.useMemo(()=>{if(c==="all")return;const t=new Date;if(c==="7d"||c==="30d"||c==="90d"){const s=c==="7d"?7:c==="30d"?30:90,l=new Date(t);return l.setDate(t.getDate()-s),{start:l,end:t}}if(c==="qtd"){const s=t.getMonth(),l=s-s%3;return{start:new Date(t.getFullYear(),l,1),end:t}}if(c==="custom"&&x&&g){const s=new Date(x),l=new Date(g);if(!isNaN(s.getTime())&&!isNaN(l.getTime())&&s<=l)return{start:s,end:l}}},[c,x,g]),k=i.useMemo(()=>{if(c!=="custom")return!1;if(!x||!g)return!0;const t=new Date(x),s=new Date(g);return isNaN(t.getTime())||isNaN(s.getTime())||t>s},[c,x,g]),[D,Y]=i.useState(""),b=i.useCallback(()=>{try{const t=O.getStudents(),s=O.getTrackingEntries(),l=O.getGoals();return{students:t,trackingEntries:s,goals:l}}catch(t){return I.error("Reports: failed to load data for export",{error:t}),{students:[],trackingEntries:[],goals:[]}}},[]),G=i.useCallback(async()=>{n(!0);try{const{students:t,trackingEntries:s,goals:l}=b();u(0);const N=await o({kind:"csv",students:t,allData:{trackingEntries:s,emotions:s.flatMap(d=>d.emotions),sensoryInputs:s.flatMap(d=>d.sensoryInputs),goals:l},options:{includeFields:["emotions","sensoryInputs","goals","trackingEntries"],dateRange:p,anonymize:f},onProgress:({progress:d})=>u(Math.round(d*100))}),v=new Blob([N],{type:"text/csv"}),w=`sensory_tracker_full_export_${new Date().toISOString().split("T")[0]}.csv`;M(v,w),F.success(String(a("dataExport.success_csv")))}catch(t){I.error("System CSV export failed",{error:t}),F.error(a("dataExport.error_generic"))}finally{n(!1)}},[b,o,p,f,a]),K=i.useCallback(async()=>{n(!0);try{const{students:t,trackingEntries:s,goals:l}=b();u(0);const N=await o({kind:"json",students:t,allData:{trackingEntries:s,emotions:s.flatMap(d=>d.emotions),sensoryInputs:s.flatMap(d=>d.sensoryInputs),goals:l},options:{includeFields:["students","trackingEntries","emotions","sensoryInputs","goals"],dateRange:p,anonymize:f},onProgress:({progress:d})=>u(Math.round(d*100))}),v=new Blob([N],{type:"application/json"}),w=`sensory_tracker_full_export_${new Date().toISOString().replace(/[:.]/g,"-")}.json`;M(v,w),F.success(String(a("dataExport.success_json")))}catch(t){I.error("System JSON export failed",{error:t}),F.error(a("dataExport.error_generic"))}finally{n(!1)}},[b,o,p,f,a]),X=i.useCallback(async()=>{n(!0);try{const{students:t,trackingEntries:s,goals:l}=b(),{exportSystem:N}=await ee(async()=>{const{exportSystem:h}=await import("./exportSystem-Cd06BMud.js");return{exportSystem:h}},__vite__mapDeps([0,1]));let v=s,w=s.flatMap(h=>h.emotions),d=s.flatMap(h=>h.sensoryInputs);if(_&&p){const{start:h,end:P}=p;v=v.filter(S=>S.timestamp>=h&&S.timestamp<=P),w=w.filter(S=>S.timestamp>=h&&S.timestamp<=P),d=d.filter(S=>S.timestamp>=h&&S.timestamp<=P)}const H=N.createFullBackup(t,{trackingEntries:v,emotions:w,sensoryInputs:d,goals:l}),Q=new Blob([JSON.stringify(H,null,2)],{type:"application/json"}),Z=`sensory_tracker_backup_${new Date().toISOString().replace(/[:.]/g,"-")}.json`;M(Q,Z),F.success(String(a("dataExport.success_backup")))}catch(t){I.error("System backup failed",{error:t}),F.error(a("dataExport.error_generic"))}finally{n(!1)}},[b,_,p,a]);return e.jsx("div",{className:"min-h-screen px-4 py-8 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"max-w-4xl mx-auto space-y-6",children:[e.jsxs("header",{className:"space-y-2",children:[e.jsx(ne,{items:[{label:r("buttons.home"),href:"/"},{label:a("title"),href:"/settings"},{label:a("dataExport.title"),current:!0}]}),e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:a("dataExport.title")}),e.jsx("p",{className:"text-muted-foreground mt-2",children:a("dataExport.description")})]}),e.jsx(re,{className:"bg-gradient-card border-0 shadow-soft",children:e.jsxs(ae,{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx(C,{className:"mb-2 block",children:r("reports.exportFilters.dateRange")}),e.jsxs(J,{value:c,onValueChange:t=>B(t),children:[e.jsx(V,{children:e.jsx(U,{})}),e.jsxs(W,{children:[e.jsx(E,{value:"all",children:r("reports.exportFilters.presets.all")}),e.jsx(E,{value:"7d",children:r("reports.exportFilters.presets.last7")}),e.jsx(E,{value:"30d",children:r("reports.exportFilters.presets.last30")}),e.jsx(E,{value:"90d",children:r("reports.exportFilters.presets.last90")}),e.jsx(E,{value:"qtd",children:r("reports.exportFilters.presets.qtd")}),e.jsx(E,{value:"custom",children:r("reports.exportFilters.presets.custom")})]})]})]}),c==="custom"&&e.jsxs("div",{className:"grid grid-cols-2 gap-2 md:col-span-2",children:[e.jsxs("div",{children:[e.jsx(C,{className:"text-sm",children:r("reports.exportFilters.start")}),e.jsx("input",{className:`w-full h-9 rounded-md border bg-background px-3 text-sm ${k?"border-destructive":""}`,type:"date","aria-invalid":k,value:x,onChange:t=>T(t.target.value)})]}),e.jsxs("div",{children:[e.jsx(C,{className:"text-sm",children:r("reports.exportFilters.end")}),e.jsx("input",{className:`w-full h-9 rounded-md border bg-background px-3 text-sm ${k?"border-destructive":""}`,type:"date","aria-invalid":k,value:g,onChange:t=>$(t.target.value)})]}),k&&e.jsx("p",{className:"col-span-2 text-xs text-destructive",role:"alert",children:r("reports.exportFilters.errors.invalidRange")})]}),e.jsxs("div",{className:"flex items-center gap-2 md:col-start-3",children:[e.jsx(q,{id:"anonymize",checked:f,onCheckedChange:t=>z(!!t)}),e.jsx(C,{htmlFor:"anonymize",children:r("reports.exportFilters.anonymize")})]}),e.jsxs("div",{className:"flex items-center gap-2 md:col-start-3",children:[e.jsx(q,{id:"backupFilters",checked:_,onCheckedChange:t=>A(!!t)}),e.jsx(C,{htmlFor:"backupFilters",children:r("reports.exportFilters.backupUseFilters")})]})]}),e.jsxs("p",{className:"text-xs text-muted-foreground","aria-live":"polite",role:"status",children:[(()=>{const t=s=>s.toISOString().slice(0,10);return p?f?r("reports.exportFilters.summary.withRangeAnon",{start:t(p.start),end:t(p.end)}):r("reports.exportFilters.summary.withRange",{start:t(p.start),end:t(p.end)}):r(f?"reports.exportFilters.summary.allAnon":"reports.exportFilters.summary.all")})(),y?` â€¢ ${r("reports.exportFilters.summary.progress",{percent:m})}`:""]}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsxs(R,{variant:"outline",onClick:G,disabled:y||k,"aria-busy":y,"data-testid":"export-csv",children:[e.jsx(oe,{className:"h-4 w-4 mr-2"}),a("dataExport.actions.exportAllCsv")]}),e.jsxs(R,{variant:"outline",onClick:K,disabled:y||k,"aria-busy":y,"data-testid":"export-json",children:[e.jsx(ie,{className:"h-4 w-4 mr-2"}),a("dataExport.actions.exportAllJson")]}),e.jsxs(R,{variant:"outline",onClick:X,disabled:y,"aria-busy":y,"data-testid":"create-backup",children:[e.jsx(le,{className:"h-4 w-4 mr-2"}),a("dataExport.actions.createBackup")]})]}),e.jsxs("div",{className:"mt-6 grid gap-3 md:grid-cols-3 items-end",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx(C,{htmlFor:"pdfStudent",children:r("reports.analyticsPdf.student")}),e.jsxs(J,{value:D,onValueChange:Y,children:[e.jsx(V,{id:"pdfStudent",children:e.jsx(U,{placeholder:r("reports.analyticsPdf.selectStudent")})}),e.jsx(W,{children:b().students.map(t=>e.jsx(E,{value:t.id,children:t.name},t.id))})]})]}),e.jsx("div",{className:"flex gap-2",children:e.jsx(R,{variant:"default",disabled:!D,onClick:()=>{const t=p,s=new URLSearchParams;s.set("tab","charts"),t&&(s.set("start",t.start.toISOString().slice(0,10)),s.set("end",t.end.toISOString().slice(0,10))),j(`/student/${D}?${s.toString()}`)},"data-testid":"analytics-pdf-link",children:r("reports.analyticsPdf.button")})})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:r("reports.analyticsPdf.helper")}),e.jsx("p",{className:"text-xs text-muted-foreground",children:a("dataExport.note")})]})})]})})};export{Ce as default};

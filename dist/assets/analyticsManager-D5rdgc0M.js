import{A as m,a as A,S as M,D as z}from"./analyticsConfig-Di1mAdDI.js";import{p as N,e as w,c as W}from"./enhancedPatternAnalysis-BSzs8ls5.js";import{o as x,r as J,p as V}from"./index-p40y1I9K.js";import{l as h}from"./logger-Bi5o39IC.js";import{storageUtils as E}from"./storageUtils-DyonkL-b.js";import{d as X}from"./dataStorage-ZXqbZ8jG.js";function j(i){if(i)return i;try{return A.getConfig()?.confidence||m.confidence}catch{return m.confidence}}function b(i){if(i)return i;try{return A.getConfig()?.insights||m.insights}catch{return m.insights}}function L(){try{return A.getConfig()||m}catch{return m}}function F(i,e,t,s){const n=j(s),r=n.THRESHOLDS,a=n.WEIGHTS,o=r.EMOTION_COUNT??r.EMOTION_ENTRIES??1,g=r.SENSORY_COUNT??r.SENSORY_ENTRIES??1,d=r.TRACKING_COUNT??r.TRACKING_ENTRIES??1,l=a.EMOTIONS??a.EMOTION??0,c=a.SENSORY??0,f=a.TRACKING??0,u=a.RECENCY_BOOST??0,p=Math.min(i.length/Math.max(1,o),1)*l,y=Math.min(e.length/Math.max(1,g),1)*c,S=Math.min(t.length/Math.max(1,d),1)*f,O=x(t),_=r.DAYS_SINCE_LAST_ENTRY??0,T=(()=>{if(O==null||!Number.isFinite(_)||_<=0)return!1;const K=Date.now(),U=1440*60*1e3,D=K-O;return D<0?!1:Math.floor(D/U)<_})(),v=V(p+y+S+(T?u:0));return J(v)}function dt(i,e,t,s){const n=b(s),r=[];if(t.length===0)return[{key:"analytics.insights.messages.noTrackingData"}];if(t.length<n.MIN_SESSIONS_FOR_FULL_ANALYTICS&&r.push({key:"analytics.insights.messages.limitedData",params:{sessions:t.length}}),i.patterns.filter(a=>a.confidence>n.HIGH_CONFIDENCE_PATTERN_THRESHOLD).slice(0,n.MAX_PATTERNS_TO_SHOW).forEach(a=>r.push({key:"analytics.insights.messages.patternDetected",params:{description:a.description,confidencePct:Math.round(a.confidence*100)}})),i.correlations.filter(a=>a.significance==="high").slice(0,n.MAX_CORRELATIONS_TO_SHOW).forEach(a=>r.push({key:"analytics.insights.messages.strongCorrelation",params:{description:a.description}})),i.predictiveInsights.slice(0,n.MAX_PREDICTIONS_TO_SHOW).forEach(a=>r.push({key:"analytics.insights.messages.prediction",params:{description:a.description,confidencePct:Math.round(a.confidence*100)}})),e.length>=n.RECENT_EMOTION_COUNT){const a=e.slice(-n.RECENT_EMOTION_COUNT),g=L().POSITIVE_EMOTIONS??m.POSITIVE_EMOTIONS,l=a.filter(f=>g.has(f.emotion.toLowerCase())).length/a.length,c=Math.round(l*100);l>n.POSITIVE_EMOTION_TREND_THRESHOLD?r.push({key:"analytics.insights.messages.positiveTrend",params:{percentage:c}}):l<n.NEGATIVE_EMOTION_TREND_THRESHOLD&&r.push({key:"analytics.insights.messages.negativeTrend",params:{percentage:c}})}return r.length===0&&r.push({key:"analytics.insights.messages.analyticsActive"}),r}function k(...i){if(i.length>=3&&i[0]&&typeof i[0]=="object"&&"patterns"in i[0]){const l=i[0],c=i[1],f=i[2],u=b(i[3]),p=L(),y=[];if(f.length===0)return["No tracking data available yet. Start by creating your first tracking session to begin pattern analysis."];if(f.length<u.MIN_SESSIONS_FOR_FULL_ANALYTICS&&y.push(`Limited data available (${f.length} sessions). Analytics will improve as more data is collected.`),l.patterns.filter(S=>S.confidence>u.HIGH_CONFIDENCE_PATTERN_THRESHOLD).slice(0,u.MAX_PATTERNS_TO_SHOW).forEach(S=>y.push(`Pattern detected: ${S.description} (${Math.round(S.confidence*100)}% confidence)`)),l.correlations.filter(S=>S.significance==="high").slice(0,u.MAX_CORRELATIONS_TO_SHOW).forEach(S=>y.push(`Strong correlation found: ${S.description}`)),l.predictiveInsights.slice(0,u.MAX_PREDICTIONS_TO_SHOW).forEach(S=>y.push(`Prediction: ${S.description} (${Math.round(S.confidence*100)}% confidence)`)),c.length>=u.RECENT_EMOTION_COUNT){const S=c.slice(-u.RECENT_EMOTION_COUNT),O=p.POSITIVE_EMOTIONS??m.POSITIVE_EMOTIONS,T=S.filter(v=>O.has(v.emotion.toLowerCase())).length/S.length;T>u.POSITIVE_EMOTION_TREND_THRESHOLD?y.push(`Positive trend: ${Math.round(T*100)}% of recent emotions have been positive.`):T<u.NEGATIVE_EMOTION_TREND_THRESHOLD&&y.push(`Consider reviewing strategies - only ${Math.round(T*100)}% of recent emotions have been positive.`)}return y.length===0&&y.push("Analytics are active and monitoring patterns. Continue collecting data for more detailed insights."),y}const e=i[0],t=i[1],s=i[2],n=i[3],r=i[4],a=i[5]??A.getConfig().insights,o=[];if(s.length<a.MIN_SESSIONS_FOR_FULL_ANALYTICS&&o.push(`Limited data available (${s.length} sessions). Continue collecting data for better insights.`),n.filter(l=>l.confidence>=a.HIGH_CONFIDENCE_PATTERN_THRESHOLD).slice(0,a.MAX_PATTERNS_TO_SHOW).forEach(l=>{const c=Math.round(l.confidence*100);o.push(`Pattern detected (${l.type}): ${l.pattern} (${c}% confidence). ${l.description}`)}),r.slice().sort((l,c)=>Math.abs(c.correlation-l.correlation)).slice(0,a.MAX_CORRELATIONS_TO_SHOW).forEach(l=>{o.push(`Correlation: ${l.factor1} â†” ${l.factor2} (r=${typeof l.correlation=="number"?l.correlation.toFixed(2):"0.00"}, ${l.significance}). ${l.description}`)}),e.length>0){const l=e.slice(-Math.max(1,a.RECENT_EMOTION_COUNT)),c=q(l.map(f=>f.emotion.toLowerCase()));c&&o.push(`Recent emotions most frequently observed: ${c.key} (${c.count} of last ${l.length}).`)}if(t.length>0){const l=t.slice(-Math.max(1,Math.min(10,t.length))),c=l.filter(u=>u.response.toLowerCase().includes("seeking")).length,f=l.filter(u=>u.response.toLowerCase().includes("avoiding")).length;c>f&&c>0?o.push("Recent sensory pattern leans toward seeking behavior. Consider structured sensory breaks."):f>c&&f>0&&o.push("Recent sensory pattern shows avoidance. Provide access to low-stimulation spaces.")}return o.slice(0,Math.max(a.MAX_PATTERNS_TO_SHOW,a.MAX_CORRELATIONS_TO_SHOW,a.MAX_PREDICTIONS_TO_SHOW,5))}function q(i){if(i.length===0)return null;const e=i.reduce((n,r)=>(n[r]=(n[r]??0)+1,n),{});let t="",s=0;for(const[n,r]of Object.entries(e))r>s&&(t=n,s=r);return t?{key:t,count:s}:null}function P(i){return{patterns:[],correlations:[],environmentalCorrelations:[],predictiveInsights:[],anomalies:[],insights:[],...i}}async function B(i,e){if(!i||!Array.isArray(i.entries)||!Array.isArray(i.emotions)||!Array.isArray(i.sensoryInputs))return h.error("[insights/unified] computeInsights: invalid inputs",{inputsType:typeof i}),P({error:"INVALID_INPUT",confidence:0,hasMinimumData:!1});try{const{entries:t,emotions:s,sensoryInputs:n}=i,r=e?.config??(()=>{try{return A.getConfig()}catch{return m}})(),a=s.length>0||n.length>0||t.length>0,o=[];let g=[],d=[],l=[];if(a){const p=r.analytics?.ANALYSIS_PERIOD_DAYS??m.analytics.ANALYSIS_PERIOD_DAYS;s.length>0&&o.push(...N.analyzeEmotionPatterns(s,p)),n.length>0&&o.push(...N.analyzeSensoryPatterns(n,p)),t.length>=(r.analytics?.MIN_TRACKING_FOR_CORRELATION??m.analytics.MIN_TRACKING_FOR_CORRELATION)&&(g=N.analyzeEnvironmentalCorrelations(t)),t.length>=(r.analytics?.MIN_TRACKING_FOR_ENHANCED??m.analytics.MIN_TRACKING_FOR_ENHANCED)&&(d=await w.generatePredictiveInsights(s,n,t,i.goals??[]),l=w.detectAnomalies(s,n,t))}const c={patterns:o,correlations:g,predictiveInsights:d,anomalies:l,hasMinimumData:a},f=k(c,s,t,r.insights),u=F(s,n,t,r.confidence);return{...c,insights:f,confidence:u}}catch(t){return h.error("[insights/unified] computeInsights failed",{error:t instanceof Error?{message:t.message,stack:t.stack,name:t.name}:t}),P({error:"ANALYTICS_UNIFIED_ERROR",confidence:0,hasMinimumData:!1})}}async function Q(i){const e=A.getConfig(),{entries:t,emotions:s}=i,n=i.results?.patterns??[],r=i.results?.correlations??[],a=i.results?.predictiveInsights??[],o=F(s,i.sensoryInputs??[],t,e.confidence),g=k({patterns:n,correlations:r,predictiveInsights:a},s,t,e.insights),d=t.length>=e.insights.MIN_SESSIONS_FOR_FULL_ANALYTICS;return{insights:g,confidence:o,hasMinimumData:d,computedAt:new Date().toISOString(),tags:i.tags}}class Z{STORAGE_KEY="sensoryTracker_alerts";SETTINGS_KEY="sensoryTracker_alertSettings";defaultSettings={enableHighIntensityAlerts:!0,highIntensityThreshold:7,enablePatternAlerts:!0,minimumDataPoints:5,alertFrequencyDays:1};generateAlertsForStudent(e,t,s,n){const r=this.getSettings();if(!r.enableHighIntensityAlerts&&!r.enablePatternAlerts)return[];const a=this.getStudentAlerts(e.id),o=Date.now()-r.alertFrequencyDays*24*60*60*1e3,g=a.filter(f=>f.alert.timestamp.getTime()>o),d=g.some(f=>f.alert.severity==="high"&&!f.resolved);if(g.length>0&&!d)return[];const c=N.generateTriggerAlerts(t,s,n,e.id).filter(f=>f.type==="concern"&&f.severity==="high"?r.enableHighIntensityAlerts:r.enablePatternAlerts&&f.dataPoints>=r.minimumDataPoints);return c.length>0&&this.saveAlerts(c),c}saveAlerts(e){try{const t=this.getAllAlerts(),s=e.map(o=>({alert:o,viewed:!1,resolved:!1})),n=[...t,...s],r=500;let a=n;if(n.length>r){const o=n.filter(d=>!d.resolved),g=n.filter(d=>d.resolved).sort((d,l)=>new Date(l.alert.timestamp).getTime()-new Date(d.alert.timestamp).getTime()).slice(0,r-o.length);a=[...o,...g].slice(-r),h.info(`Alert storage limit reached. Cleaned up ${n.length-a.length} old alerts.`)}E.safeSetItem(this.STORAGE_KEY,JSON.stringify(a))}catch(t){const s=t instanceof Error?t:new Error(String(t));h.error("Error saving alerts:",s),this.cleanupOldAlerts(7);try{const n=this.getAllAlerts().slice(-100),r=e.map(a=>({alert:a,viewed:!1,resolved:!1}));E.safeSetItem(this.STORAGE_KEY,JSON.stringify([...n,...r]))}catch(n){const r=n instanceof Error?n:new Error(String(n));h.error("Failed to save alerts even after cleanup:",r)}}}getAllAlerts(){try{const e=localStorage.getItem(this.STORAGE_KEY);return e?JSON.parse(e).map(s=>({...s,alert:{...s.alert,timestamp:new Date(s.alert.timestamp)},resolvedAt:s.resolvedAt?new Date(s.resolvedAt):void 0})):[]}catch(e){const t=e instanceof Error?e:new Error(String(e));return h.error("Error loading alerts:",t),[]}}getStudentAlerts(e){return this.getAllAlerts().filter(t=>t.alert.studentId===e)}getUnviewedAlerts(){return this.getAllAlerts().filter(e=>!e.viewed)}getUnresolvedAlerts(){return this.getAllAlerts().filter(e=>!e.resolved)}markAlertAsViewed(e){try{const s=this.getAllAlerts().map(n=>n.alert.id===e?{...n,viewed:!0}:n);E.safeSetItem(this.STORAGE_KEY,JSON.stringify(s))}catch(t){const s=t instanceof Error?t:new Error(String(t));h.error("Error marking alert as viewed:",s)}}resolveAlert(e,t,s){try{const r=this.getAllAlerts().map(a=>a.alert.id===e?{...a,resolved:!0,resolvedAt:new Date,resolvedBy:t,resolvedNotes:s}:a);E.safeSetItem(this.STORAGE_KEY,JSON.stringify(r))}catch(n){const r=n instanceof Error?n:new Error(String(n));h.error("Error resolving alert:",r)}}deleteAlert(e){try{const s=this.getAllAlerts().filter(n=>n.alert.id!==e);E.safeSetItem(this.STORAGE_KEY,JSON.stringify(s))}catch(t){const s=t instanceof Error?t:new Error(String(t));h.error("Error deleting alert:",s)}}getSettings(){try{const e=localStorage.getItem(this.SETTINGS_KEY);return e?{...this.defaultSettings,...JSON.parse(e)}:this.defaultSettings}catch(e){const t=e instanceof Error?e:new Error(String(e));return h.error("Error loading alert settings:",t),this.defaultSettings}}updateSettings(e){try{const s={...this.getSettings(),...e};E.safeSetItem(this.SETTINGS_KEY,JSON.stringify(s))}catch(t){const s=t instanceof Error?t:new Error(String(t));h.error("Error updating alert settings:",s)}}getAlertSummary(){const e=this.getAllAlerts(),t=this.getUnviewedAlerts(),s=this.getUnresolvedAlerts(),n=e.reduce((a,o)=>(a[o.alert.severity]=(a[o.alert.severity]||0)+1,a),{}),r=e.reduce((a,o)=>(a[o.alert.type]=(a[o.alert.type]||0)+1,a),{});return{total:e.length,unviewed:t.length,unresolved:s.length,bySeverity:n,byType:r}}cleanupOldAlerts(e=90){try{const t=new Date;t.setDate(t.getDate()-e);const s=this.getAllAlerts(),n=s.filter(r=>r.alert.timestamp>=t||!r.resolved);E.safeSetItem(this.STORAGE_KEY,JSON.stringify(n)),h.info(`Cleaned up ${s.length-n.length} old alerts`)}catch(t){const s=t instanceof Error?t:new Error(String(t));h.error("Error cleaning up old alerts:",s)}}exportAlerts(e){const t=e?this.getStudentAlerts(e):this.getAllAlerts();return JSON.stringify({exportDate:new Date().toISOString(),studentId:e||"all",alerts:t},null,2)}}const tt=new Z;let C=null;function et(){const i=new Map;try{const e=typeof localStorage<"u"?localStorage.getItem(M.analyticsProfiles):null;if(!e)return i;const t=JSON.parse(e);for(const[s,n]of Object.entries(t))n&&typeof n.studentId=="string"&&i.set(s,{...n,lastAnalyzedAt:n.lastAnalyzedAt?new Date(n.lastAnalyzedAt):null})}catch(e){h.error("[analyticsProfiles] Failed to load profiles",{error:e})}return i}function Y(){C||(C=et())}function nt(){return Y(),C}function R(){Y();try{const i=Object.fromEntries(C.entries());typeof localStorage<"u"&&localStorage.setItem(M.analyticsProfiles,JSON.stringify(i))}catch(i){h.error("[analyticsProfiles] Failed to save profiles",{error:i})}}function G(i){const e=i??z,{insights:t,confidence:s,analytics:n,timeWindows:r}=e;return{insights:t,confidence:s,analytics:n,timeWindows:r}}function $(i,e){const{entries:t,emotions:s,sensoryInputs:n,goals:r}=i,a=G(e?.config),o={counts:{entries:t?.length??0,emotions:s?.length??0,sensory:n?.length??0,goals:r?.length??0},latestTimestamps:{entries:t&&t.length?new Date(Math.max(...t.map(g=>new Date(g.timestamp).getTime()))).toISOString():null,emotions:s&&s.length?new Date(Math.max(...s.map(g=>new Date(g.timestamp).getTime()))).toISOString():null,sensory:n&&n.length?new Date(Math.max(...n.map(g=>new Date(g.timestamp).getTime()))).toISOString():null},config:a};return W({namespace:"insights",input:o,normalizeArrayOrder:!0})}function st(i){if(typeof i?.ttlSeconds=="number")return i.ttlSeconds;try{const t=A.getConfig()?.cache?.ttl;if(typeof t=="number"&&Number.isFinite(t))return Math.max(1,Math.floor(t/1e3))}catch{}return 300}function rt(i,e){const t=$(i,e),s=st(e),n=e?.config?G(e.config):void 0,r=["insights","v2"],a=e?.tags&&e.tags.length?Array.from(new Set([...r,...e.tags])):r;return{type:"Insights/Compute",payload:{inputs:i,config:n},cacheKey:t,ttlSeconds:s,tags:a}}function it(i){return nt()}let H=null;class I{static instance;analyticsProfiles;analyticsCache=new Map;storage;constructor(e,t){this.storage=e,this.analyticsProfiles=t}static getInstance(e=X,t){if(!I.instance){let s=null;try{s=typeof localStorage<"u"?localStorage.getItem(M.analyticsProfiles):null}catch{}const n=t??it();I.instance=new I(e,n)}return I.instance}initializeStudentAnalytics(e){try{if(!e||typeof e!="string"){h.warn("[analyticsManager] initializeStudentAnalytics: invalid studentId",{studentId:e});return}if(this.analyticsProfiles.has(e))return;const t={studentId:e,isInitialized:!0,lastAnalyzedAt:null,analyticsConfig:{patternAnalysisEnabled:!0,correlationAnalysisEnabled:!0,predictiveInsightsEnabled:!0,anomalyDetectionEnabled:!0,alertSystemEnabled:!0},minimumDataRequirements:{emotionEntries:1,sensoryEntries:1,trackingEntries:1},analyticsHealthScore:0};this.analyticsProfiles.set(e,t),R()}catch(t){h.error("[analyticsManager] initializeStudentAnalytics failed",{error:t,studentId:e})}}async getStudentAnalytics(e){this.initializeStudentAnalytics(e.id);const t=await this.generateAnalytics(e);this.analyticsCache.set(e.id,{results:t,timestamp:new Date});const s=this.analyticsProfiles.get(e.id);if(s){const n={...s,lastAnalyzedAt:new Date,analyticsHealthScore:this.calculateHealthScore(t)};this.analyticsProfiles.set(e.id,n),R()}return t}async generateAnalytics(e){if(!e||!e.id)return h.error("[analyticsManager] generateAnalytics: invalid student",{student:e}),{patterns:[],correlations:[],environmentalCorrelations:[],predictiveInsights:[],anomalies:[],insights:[],error:"INVALID_STUDENT"};try{const t=this.storage.getTrackingEntriesForStudent(e.id)||[],s=this.storage.getGoalsForStudent(e.id)||[],n=t.flatMap(g=>g.emotions||[]),r=t.flatMap(g=>g.sensoryInputs||[]),a=(()=>{try{return A.getConfig()}catch{return null}})(),o=await B({entries:t,emotions:n,sensoryInputs:r,goals:s},a?{config:a}:void 0);try{if((a?.features?.enableSummaryFacade??m.features?.enableSummaryFacade)===!0){const d=await Q({entries:t,emotions:n,sensoryInputs:r,results:{patterns:o.patterns??[],correlations:o.correlations??[],predictiveInsights:o.predictiveInsights??[]}});o.insights=d.insights,o.hasMinimumData=d.hasMinimumData,o.confidence=d.confidence;try{const l=new Date().getMinutes();H!==l&&(h.debug("[analyticsManager] Using summary facade for insights",{studentId:e.id,entries:t.length,emotions:n.length,sensory:r.length}),H=l)}catch{}}}catch{}return t.length>0&&await tt.generateAlertsForStudent(e,n,r,t),o}catch(t){return h.error(`[analyticsManager] generateAnalytics failed for student ${e.id}`,{error:t instanceof Error?{message:t.message,stack:t.stack,name:t.name}:t}),{patterns:[],correlations:[],environmentalCorrelations:[],predictiveInsights:[],anomalies:[],insights:[],error:"ANALYTICS_GENERATION_FAILED"}}}calculateHealthScore(e){const t=(()=>{try{return A.getConfig()}catch{return null}})(),{WEIGHTS:s}=t?.healthScore??m.healthScore;let n=0;e.patterns.length>0&&(n+=s.PATTERNS),e.correlations.length>0&&(n+=s.CORRELATIONS),e.predictiveInsights.length>0&&(n+=s.PREDICTIONS),e.anomalies.length>0&&(n+=s.ANOMALIES);const r=e;(r.hasMinimumData??(e.patterns.length>0||e.correlations.length>0))&&(n+=s.MINIMUM_DATA);const o=typeof r.confidence=="number"?r.confidence:1;return Math.round(n*o)}async triggerAnalyticsForStudent(e){try{if(!e||!e.id){h.warn("[analyticsManager] triggerAnalyticsForStudent: invalid student",{student:e});return}this.analyticsCache.delete(e.id),await this.getStudentAnalytics(e)}catch(t){h.error("[analyticsManager] triggerAnalyticsForStudent failed",{error:t,studentId:e?.id})}}async triggerAnalyticsForAllStudents(){const e=this.storage.getStudents(),t=e.map(n=>(this.initializeStudentAnalytics(n.id),this.triggerAnalyticsForStudent(n)));(await Promise.allSettled(t)).forEach((n,r)=>{n.status==="rejected"&&h.error(`Failed to process analytics for student ${e[r].id}:`,n.reason)})}getAnalyticsStatus(){return this.storage.getStudents().map(t=>{const s=this.analyticsProfiles.get(t.id),n=this.analyticsCache.get(t.id);return{studentId:t.id,studentName:t.name,isInitialized:s?.isInitialized??!1,lastAnalyzed:s?.lastAnalyzedAt??null,healthScore:s?.analyticsHealthScore??0,hasMinimumData:n?.results.hasMinimumData??!1}})}clearCache(e){e?this.analyticsCache.delete(e):this.analyticsCache.clear()}saveAnalyticsProfiles(){try{R()}catch(e){h.error("Error saving analytics profiles:",e)}}}const ut=I.getInstance(),St=$,mt=rt;export{ut as a,St as b,mt as c,tt as d,dt as g};

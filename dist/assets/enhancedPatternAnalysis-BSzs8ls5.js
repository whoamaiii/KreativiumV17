import{a as T}from"./analyticsConfig-Di1mAdDI.js";import{n as U,k as Ee,f as Pe}from"./vendor-utils-BNQKEpbf.js";import{z,t as ke,a as ne,g as ct,d as lt,m as mt,b as dt,c as ht,s as ue,l as ge,e as te,f as Y,h as fe,w as $e,i as Le,j as Ne}from"./ml-BTt1mEdE.js";import{l as k}from"./logger-Bi5o39IC.js";class Fe{config;constructor(){this.config=T.getConfig(),T.subscribe(e=>{this.config=e})}analyzeEmotionPatterns(e,n){const t=n||this.config.timeWindows.defaultAnalysisDays;if(e.length<this.config.patternAnalysis.minDataPoints)return[];const a=[],s=U(new Date,t),i=e.filter(u=>u.timestamp>=s),r=this.config.patternAnalysis.highIntensityThreshold*(1/this.config.alertSensitivity.emotionIntensityMultiplier),c=this.config.patternAnalysis.concernFrequencyThreshold*(1/this.config.alertSensitivity.frequencyMultiplier),g=i.filter(u=>u.intensity>=r&&["anxious","frustrated","angry","overwhelmed","sad"].includes(u.emotion.toLowerCase())),d=Math.max(1,this.config.patternAnalysis.highIntensityThreshold-1),l=i.filter(u=>u.intensity>=d&&["anxious","frustrated","angry","overwhelmed","sad"].includes(u.emotion.toLowerCase()));g.length/i.length>c&&a.push({type:"emotion",pattern:"high-intensity-negative",confidence:Math.min(g.length/i.length,1),frequency:g.length,description:`High-intensity negative emotions detected in ${Math.round(g.length/i.length*100)}% of recent sessions`,recommendations:["Consider implementing calming strategies before intense activities","Monitor environmental triggers that may contribute to stress","Discuss coping mechanisms with student"],dataPoints:i.length,timeframe:`${t} days`});const h=i.reduce((u,f)=>(u[f.emotion.toLowerCase()]=(u[f.emotion.toLowerCase()]||0)+1,u),{});let m,w=0;for(const[u,f]of Object.entries(h))f>w&&(w=f,m=[u,f]);return m&&m[1]/i.length>this.config.patternAnalysis.emotionConsistencyThreshold&&a.push({type:"emotion",pattern:"consistent-emotion",confidence:m[1]/i.length,frequency:m[1],description:`Consistent ${m[0]} emotion pattern detected`,recommendations:this.getEmotionRecommendations(m[0]),dataPoints:i.length,timeframe:`${t} days`}),g.length===0&&l.length/i.length>this.config.patternAnalysis.moderateNegativeThreshold&&a.push({type:"emotion",pattern:"moderate-negative-trend",confidence:l.length/i.length,frequency:l.length,description:`Moderate negative emotions detected in ${Math.round(l.length/i.length*100)}% of recent sessions`,recommendations:["Monitor for potential stress escalation","Implement preventive calming strategies","Consider environmental adjustments"],dataPoints:i.length,timeframe:`${t} days`}),a}analyzeSensoryPatterns(e,n){const t=n||this.config.timeWindows.defaultAnalysisDays;if(e.length<this.config.patternAnalysis.minDataPoints)return[];const a=[],s=U(new Date,t),i=e.filter(f=>f.timestamp>=s),r=i.filter(f=>f.response.toLowerCase().includes("seeking")||f.response.toLowerCase().includes("craving")),c=i.filter(f=>f.response.toLowerCase().includes("avoiding")||f.response.toLowerCase().includes("covering")),g=1+this.config.patternAnalysis.concernFrequencyThreshold,d=this.config.patternAnalysis.concernFrequencyThreshold,l=c.length>0,h=r.length>0,m=Math.max(1,i.length),w=r.length/m,u=c.length/m;return l&&r.length/Math.max(1,c.length)>g?a.push({type:"sensory",pattern:"sensory-seeking",confidence:r.length/i.length,frequency:r.length,description:"Strong sensory-seeking pattern identified",recommendations:["Provide scheduled sensory breaks","Offer fidget tools and movement opportunities","Consider sensory-rich learning activities"],dataPoints:i.length,timeframe:`${t} days`}):h&&c.length/Math.max(1,r.length)>g?a.push({type:"sensory",pattern:"sensory-avoiding",confidence:c.length/i.length,frequency:c.length,description:"Strong sensory-avoiding pattern identified",recommendations:["Provide quiet, low-stimulation spaces","Use noise-canceling headphones when appropriate","Gradually introduce sensory experiences"],dataPoints:i.length,timeframe:`${t} days`}):!l&&h&&w>=d?a.push({type:"sensory",pattern:"sensory-seeking",confidence:w,frequency:r.length,description:"Prevalent sensory-seeking behavior observed",recommendations:["Provide scheduled sensory breaks","Offer fidget tools and movement opportunities","Consider sensory-rich learning activities"],dataPoints:i.length,timeframe:`${t} days`}):!h&&l&&u>=d&&a.push({type:"sensory",pattern:"sensory-avoiding",confidence:u,frequency:c.length,description:"Prevalent sensory-avoiding behavior observed",recommendations:["Provide quiet, low-stimulation spaces","Use noise-canceling headphones when appropriate","Gradually introduce sensory experiences"],dataPoints:i.length,timeframe:`${t} days`}),a}analyzeEnvironmentalCorrelations(e){if(e.length<this.config.patternAnalysis.minDataPoints)return[];const n=[],t=e.filter(r=>r.environmentalData?.roomConditions?.noiseLevel&&r.emotions.length>0).map(r=>({noise:r.environmentalData.roomConditions.noiseLevel,avgEmotionIntensity:r.emotions.reduce((c,g)=>c+g.intensity,0)/r.emotions.length}));if(t.length>=this.config.patternAnalysis.minDataPoints){const r=t.map(m=>m.noise).filter(m=>typeof m=="number"&&!isNaN(m)),c=t.map(m=>m.avgEmotionIntensity).filter(m=>typeof m=="number"&&!isNaN(m)),g=Math.min(r.length,c.length),d=r.slice(0,g),l=c.slice(0,g),h=this.calculateCorrelation(d,l);Math.abs(h)>this.config.patternAnalysis.correlationThreshold&&n.push({factor1:"Noise Level",factor2:"Emotion Intensity",correlation:h,significance:this.getSignificance(Math.abs(h)),description:h>0?"Higher noise levels correlate with more intense emotions":"Lower noise levels correlate with more intense emotions",recommendations:h>0?["Consider noise reduction strategies","Provide quiet spaces during intense activities"]:["Monitor for overstimulation in quiet environments"]})}const s=e.filter(r=>r.environmentalData?.roomConditions?.lighting&&r.emotions.length>0).map(r=>({lighting:r.environmentalData.roomConditions.lighting,positiveEmotions:r.emotions.filter(c=>(this.config.taxonomy?.positiveEmotions||[]).includes(c.emotion.toLowerCase())).length/r.emotions.length})).reduce((r,c)=>{const g=String(c.lighting??"unknown");return r[g]||(r[g]=[]),r[g].push(c.positiveEmotions),r},{}),i=Object.entries(s).map(([r,c])=>{const g=(c||[]).filter(h=>typeof h=="number"&&!isNaN(h)),d=g.length,l=d>0?g.reduce((h,m)=>h+m,0)/d:0;return{lighting:r,average:l,count:d}}).filter(r=>r.count>=this.config.patternAnalysis.minDataPoints).sort((r,c)=>c.average-r.average);if(i.length>1){const r=i[0],c=i[i.length-1];r.average-c.average>this.config.patternAnalysis.concernFrequencyThreshold&&n.push({factor1:"Lighting Conditions",factor2:"Positive Emotions",correlation:.5,significance:"moderate",description:`${r.lighting} lighting shows highest positive emotion rates (${Math.round(r.average*100)}%)`,recommendations:[`Optimize for ${r.lighting} lighting when possible`,`Minimize exposure to ${c.lighting} lighting during challenging activities`]})}return n}generateTriggerAlerts(e,n,t,a){const s=[],i=U(new Date,this.config.timeWindows.recentDataDays),r=e.filter(m=>m.timestamp>=i),c=t.filter(m=>m.timestamp>=i),g=this.config.patternAnalysis.highIntensityThreshold*(1/this.config.alertSensitivity.emotionIntensityMultiplier),d=r.filter(m=>m.intensity>=g&&["anxious","frustrated","overwhelmed","angry"].includes(m.emotion.toLowerCase()));d.length>=this.config.patternAnalysis.minDataPoints&&s.push({id:globalThis?.crypto?.randomUUID?.()||`alert-${Math.random().toString(36).slice(2)}-${Date.now()}`,type:"concern",severity:"high",title:"High Stress Pattern Detected",description:`${d.length} high-intensity stress responses recorded in the past ${this.config.timeWindows.recentDataDays} days`,recommendations:["Schedule a check-in with the student","Review current stressors and triggers","Implement additional calming strategies","Consider environmental modifications"],timestamp:new Date,studentId:a,dataPoints:r.length});const l=r.filter(m=>(this.config.taxonomy?.positiveEmotions||[]).includes(m.emotion.toLowerCase())&&m.intensity>=this.config.patternAnalysis.highIntensityThreshold);return l.length>=this.config.patternAnalysis.minDataPoints&&r.length>=this.config.patternAnalysis.minDataPoints&&s.push({id:globalThis?.crypto?.randomUUID?.()||`alert-${Math.random().toString(36).slice(2)}-${Date.now()}`,type:"improvement",severity:"low",title:"Positive Progress Noted",description:`Strong positive emotional responses observed in ${Math.round(l.length/r.length*100)}% of recent sessions`,recommendations:["Continue current successful strategies","Document what is working well","Consider sharing success with student and family"],timestamp:new Date,studentId:a,dataPoints:r.length}),this.analyzeEnvironmentalCorrelations(c).forEach(m=>{m.significance==="high"&&Math.abs(m.correlation)>this.config.patternAnalysis.correlationThreshold*2&&s.push({id:globalThis?.crypto?.randomUUID?.()||`alert-${Math.random().toString(36).slice(2)}-${Date.now()}`,type:"pattern",severity:"medium",title:"Environmental Pattern Identified",description:m.description,recommendations:m.recommendations||[],timestamp:new Date,studentId:a,dataPoints:c.length})}),s}calculateCorrelation(e,n){const t=e.length;if(t===0||t!==n.length)return 0;const a=e.reduce((l,h)=>l+h,0),s=n.reduce((l,h)=>l+h,0),i=e.map((l,h)=>l*n[h]).reduce((l,h)=>l+h,0),r=e.map(l=>l*l).reduce((l,h)=>l+h,0),c=n.map(l=>l*l).reduce((l,h)=>l+h,0),g=t*i-a*s,d=Math.sqrt((t*r-a*a)*(t*c-s*s));return d===0?0:g/d}getSignificance(e){const n=this.config.patternAnalysis.correlationThreshold,t=this.config.patternAnalysis.correlationThreshold*2;return e<n?"low":e<t?"moderate":"high"}getEmotionRecommendations(e){return{anxious:["Introduce mindfulness and breathing exercises","Create predictable routines and schedules","Provide advance notice of changes"],frustrated:["Break tasks into smaller, manageable steps","Offer choice and control opportunities","Teach problem-solving strategies"],happy:["Continue activities that promote positive engagement","Document successful strategies for future use","Build on current strengths"],calm:["Maintain current supportive environment","Use as a baseline for comparison","Gradually introduce new challenges"]}[e.toLowerCase()]||["Monitor patterns and adjust strategies as needed","Consult with support team for specialized approaches"]}}const gt=new Fe,G="1.0.0",pe=(o,e={})=>{if(!o||o.length===0)return[];const n=T.getConfig(),{min:t,max:a,clampToUnit:s=n.featureEngineering.normalization.clampToUnit,minVariance:i=n.featureEngineering.normalization.minVariance}=e,r=t??Math.min(...o),g=(a??Math.max(...o))-r;if(g<i)return new Array(o.length).fill(.5);const d=o.map(l=>(l-r)/g);return s?d.map(l=>Math.max(0,Math.min(1,l))):d},me=(o,e="sixFeatureV1")=>{const n=T.getConfig();if((e==="sixFeatureV1"?e:n.featureEngineering.timeEncoding.variant)==="none")return[];const a=o.getHours(),s=o.getDate(),i=o.getMonth()+1,r=Math.sin(2*Math.PI*a/24),c=Math.cos(2*Math.PI*a/24),g=Math.sin(2*Math.PI*(s-1)/31),d=Math.cos(2*Math.PI*(s-1)/31),l=Math.sin(2*Math.PI*(i-1)/12),h=Math.cos(2*Math.PI*(i-1)/12);return[r,c,g,d,l,h]},oe=o=>{if(!o||o.length===0)return[];const e=T.getConfig(),n=new Set(e.taxonomy.positiveEmotions.map(s=>s.toLowerCase())),t=new Map;o.forEach(s=>{const i=s.timestamp.toISOString().split("T")[0];t.has(i)||t.set(i,[]),t.get(i).push(s)});const a=[];return t.forEach((s,i)=>{const r=new Map;s.forEach(p=>{p.emotions.forEach(M=>{const y=M.emotion.toLowerCase();r.has(y)||r.set(y,{totalIntensity:0,count:0});const v=r.get(y);v.totalIntensity+=M.intensity,v.count+=1})});const c={happy:0,sad:0,angry:0,anxious:0,calm:0,energetic:0,frustrated:0};r.forEach(({totalIntensity:p,count:M},y)=>{const v=p/M;y.includes("happy")||y.includes("joy")||n.has(y)?c.happy=Math.max(c.happy,v):y.includes("sad")||y.includes("down")?c.sad=Math.max(c.sad,v):y.includes("angry")||y.includes("mad")?c.angry=Math.max(c.angry,v):y.includes("anxious")||y.includes("worry")||y.includes("nervous")?c.anxious=Math.max(c.anxious,v):y.includes("calm")||y.includes("peaceful")||y.includes("relax")?c.calm=Math.max(c.calm,v):y.includes("energetic")||y.includes("excited")||y.includes("active")?c.energetic=Math.max(c.energetic,v):(y.includes("frustrated")||y.includes("annoyed"))&&(c.frustrated=Math.max(c.frustrated,v))});const g=new Map,d=["visual","auditory","tactile","vestibular","proprioceptive"];d.forEach(p=>{g.set(p,{seeking:0,avoiding:0,neutral:0,total:0})}),s.forEach(p=>{p.sensoryInputs.forEach(M=>{const y=(M.sensoryType||M.type||"visual").toLowerCase(),v=M.response.toLowerCase();if(g.has(y)){const b=g.get(y);b.total+=1,v.includes("seeking")||v.includes("craving")||v.includes("want")?b.seeking+=1:v.includes("avoiding")||v.includes("overwhelm")||v.includes("dislike")?b.avoiding+=1:b.neutral+=1}})});const l={};d.forEach(p=>{const M=g.get(p);M.total>0&&(M.seeking>=M.avoiding&&M.seeking>=M.neutral?l[p]="seeking":M.avoiding>=M.neutral?l[p]="avoiding":l[p]="neutral")});const h={},m=[...s].reverse().find(p=>p.environmentalData?.roomConditions);if(m?.environmentalData?.roomConditions){const p=m.environmentalData.roomConditions;p.lighting&&(p.lighting.toLowerCase().includes("bright")?h.lighting="bright":p.lighting.toLowerCase().includes("dim")||p.lighting.toLowerCase().includes("low")?h.lighting="dim":h.lighting="moderate"),typeof p.noiseLevel=="number"&&(p.noiseLevel>70?h.noise="loud":p.noiseLevel<40?h.noise="quiet":h.noise="moderate"),typeof p.temperature=="number"&&(p.temperature>75?h.temperature="hot":p.temperature<65?h.temperature="cold":h.temperature="comfortable")}const w=s.filter(p=>p.environmentalData?.classroom?.activity).map(p=>p.environmentalData.classroom.activity).filter((p,M,y)=>y.indexOf(p)===M),u=s.map(p=>[p.generalNotes,p.notes].filter(Boolean)).flat().join(" | "),f={id:`session_${i}_${s[0].studentId}`,studentId:s[0].studentId,date:`${i}T00:00:00.000Z`,emotion:c,sensory:l,environment:h,activities:w,notes:u};a.push(f)}),a.sort((s,i)=>new Date(s.date).getTime()-new Date(i.date).getTime()),a},ye=(o,e=7)=>{if(!o||o.length<e){const M=z([0,e,13]),y=z([0,7]);return{inputs:M,outputs:y,meta:{normalizers:{min:0,max:1},schemaVersion:G}}}const n=["happy","sad","angry","anxious","calm","energetic","frustrated"],t=[],a=[],s=T.getConfig();for(let M=0;M<o.length-e+1;M++){const y=[];for(let S=M;S<M+e;S++){const I=o[S],D=n.map(E=>I.emotion[E]||0),A=me(new Date(I.date));y.push([...D,...A])}const v=o[M+e-1],b=n.map(S=>v.emotion[S]||0);t.push(y.flat()),a.push(b)}if(t.length===0){const M=z([0,e,13]),y=z([0,7]);return{inputs:M,outputs:y,meta:{normalizers:{min:0,max:1},schemaVersion:G}}}const i=t.flat(),r=pe(i,{clampToUnit:s.featureEngineering.normalization.clampToUnit,minVariance:s.featureEngineering.normalization.minVariance}),c=a.flat(),g=pe(c,{clampToUnit:s.featureEngineering.normalization.clampToUnit,minVariance:s.featureEngineering.normalization.minVariance}),d=[...i,...c],l=Math.min(...d),h=Math.max(...d),m=[];let w=0;for(let M=0;M<t.length;M++){const y=[];for(let v=0;v<e;v++){const b=[];for(let S=0;S<13;S++)b.push(r[w++]);y.push(b)}m.push(y)}const u=[];w=0;for(let M=0;M<a.length;M++){const y=[];for(let v=0;v<7;v++)y.push(g[w++]);u.push(y)}const f=ke(m),p=ne(u);return{inputs:f,outputs:p,meta:{normalizers:{min:l,max:h},schemaVersion:G}}},Re=o=>{if(!o||o.length===0){const s=z([0,12]),i=z([0,15]);return{inputs:s,outputs:i,meta:{schemaVersion:G}}}const e=[],n=[];if(o.forEach(s=>{const i=[s.environment.lighting==="bright"?1:s.environment.lighting==="dim"?.5:0,s.environment.noise==="loud"?1:s.environment.noise==="moderate"?.5:0,s.environment.temperature==="hot"?1:s.environment.temperature==="cold"?0:.5,s.environment.crowded==="very"?1:s.environment.crowded==="moderate"?.5:0,s.environment.smells?1:0,s.environment.textures?1:0],r=me(new Date(s.date)),c=[...i,...r],g=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];["visual","auditory","tactile","vestibular","proprioceptive"].forEach((l,h)=>{const m=s.sensory[l],w=h*3;m==="seeking"?g[w]=1:m==="avoiding"?g[w+1]=1:g[w+2]=1}),e.push(c),n.push(g)}),e.length===0){const s=z([0,12]),i=z([0,15]);return{inputs:s,outputs:i,meta:{schemaVersion:G}}}const t=ne(e),a=ne(n);return{inputs:t,outputs:a,meta:{schemaVersion:G}}};function Se(o){if(Object.prototype.toString.call(o)!=="[object Object]")return!1;const e=Object.getPrototypeOf(o);return e===null||e===Object.prototype}function re(o){return o instanceof Date&&!Number.isNaN(o.getTime())}function ae(o){return typeof Map<"u"&&o instanceof Map}function ce(o){return typeof Set<"u"&&o instanceof Set}function O(o,e){if(o==null)return o;const n=typeof o;if(n==="string"||n==="number"||n==="boolean")return o;if(n==="bigint")return{$type:"BigInt",value:o.toString()};if(n==="symbol")return{$type:"Symbol",value:String(o)};if(n==="function")return{$type:"Function",value:o.name||"anonymous"};if(re(o))return{$type:"Date",value:o.toISOString()};if(ce(o))return{$type:"Set",value:Array.from(o).map(s=>O(s,e)).map(s=>({v:s,k:JSON.stringify(s)})).sort((s,i)=>s.k<i.k?-1:s.k>i.k?1:0).map(s=>s.v)};if(ae(o))return{$type:"Map",value:Array.from(o.entries()).map(([s,i])=>[O(s,e),O(i,e)]).map(s=>({e:s,k:JSON.stringify(s[0])})).sort((s,i)=>s.k<i.k?-1:s.k>i.k?1:0).map(s=>s.e)};if(Array.isArray(o)){const t=o.map(a=>O(a,e));return e?t.map(a=>({v:a,k:JSON.stringify(a)})).sort((a,s)=>a.k<s.k?-1:a.k>s.k?1:0).map(a=>a.v):t}if(Se(o)){const t=Object.keys(o).sort(),a={};for(const s of t)a[s]=O(o[s],e);return a}try{const t=o.valueOf?.();if(t!==o&&t!==void 0)return O(t,e)}catch{}return{$type:o?.constructor?.name||"Object",value:String(o)}}function ze(o,e=!1){const n=O(o,e);return JSON.stringify(n)}function Ve(o){if(typeof TextEncoder<"u")return new TextEncoder().encode(o);const e=[];for(let n=0;n<o.length;n++){const t=o.charCodeAt(n);if(t<128)e.push(t);else if(t<2048)e.push(192|t>>6),e.push(128|t&63);else if(t<55296||t>=57344)e.push(224|t>>12),e.push(128|t>>6&63),e.push(128|t&63);else{n++;const a=o.charCodeAt(n),s=65536+((t&1023)<<10|a&1023);e.push(240|s>>18),e.push(128|s>>12&63),e.push(128|s>>6&63),e.push(128|s&63)}}return new Uint8Array(e)}function Te(o,e=!1){const n=typeof o=="string"?o:ze(o,e),t=Ve(n);let a=2166136261;for(let i=0;i<t.length;i++)a^=t[i],a=(a>>>0)*16777619;return(a>>>0).toString(16).padStart(8,"0")}function Oe(o){const e={arrays:0,arrayItems:0,objects:0,keys:0,primitives:0},n=t=>{if(t==null){e.primitives+=1;return}const a=typeof t;if(a==="string"||a==="number"||a==="boolean"||a==="bigint"||a==="symbol"||a==="function"){e.primitives+=1;return}if(re(t)||ce(t)||ae(t)){if(re(t)){e.objects+=1,e.keys+=1,e.primitives+=1;return}if(ce(t)){e.objects+=1,e.arrays+=1;const s=t.size;e.arrayItems+=s;for(const i of t)n(i);return}if(ae(t)){e.objects+=1,e.arrays+=1;const s=t.size;e.arrayItems+=s;for(const[i,r]of t)n(i),n(r);return}}if(Array.isArray(t)){e.arrays+=1,e.arrayItems+=t.length;for(const s of t)n(s);return}if(Se(t)){e.objects+=1;const s=Object.keys(t);e.keys+=s.length;for(const i of s)n(t[i]);return}e.objects+=1,e.keys+=1};return n(o),e}function B(o){const{namespace:e,input:n,version:t,normalizeArrayOrder:a=!1}=o;if(!e||typeof e!="string")throw new Error("createCacheKey: 'namespace' must be a non-empty string");const s=Oe(n),i=Te(n,a),r=[];return r.push(e),t&&r.push(`v${t}`),r.push(`c${s.arrays}`,`i${s.arrayItems}`,`o${s.objects}`,`k${s.keys}`,`p${s.primitives}`),r.push(i),r.join(":")}const H=new Map,xe="model-eval",je=300*1e3,_e=300,R=new Map;let Ce=je;function qe(o){return B({namespace:xe,input:{mt:o.modelType,task:o.taskType,dataSig:o.dataSignature,cfgSig:o.configSignature},version:o.schemaVersion,normalizeArrayOrder:!1})}function Be(o,e){const n=Date.now();for(R.has(o)&&R.delete(o),R.set(o,{ts:n,tags:e});R.size>_e;){const t=R.keys().next().value;if(!t)break;R.delete(t)}}function He(o){const e=R.get(o);return e?Date.now()-e.ts<=Ce?!0:(R.delete(o),!1):!1}const Ue="model-eval",J="model-eval",Ge=1;let se=typeof indexedDB<"u",ve=!1;function Ie(){return se?new Promise((o,e)=>{try{const n=indexedDB.open(Ue,Ge);n.onupgradeneeded=t=>{try{const a=t.target.result;a.objectStoreNames.contains(J)||a.createObjectStore(J,{keyPath:"id"})}catch(a){k.error("[modelEvaluation] onupgradeneeded failed",a)}},n.onsuccess=()=>o(n.result),n.onerror=()=>e(n.error)}catch(n){e(n)}}):Promise.reject(new Error("IndexedDB not available"))}async function We(){if(se)try{const o=await Ie();await new Promise((e,n)=>{try{const s=o.transaction([J],"readonly").objectStore(J).openCursor();s.onerror=()=>n(s.error),s.onsuccess=()=>{const i=s.result;if(i){const r=i.value;if(r&&r.modelType){const c=H.get(r.modelType)??[];c.push(r),H.set(r.modelType,c)}i.continue()}else e()}}catch(t){n(t)}});for(const[e,n]of H.entries())n.sort((t,a)=>a.timestamp-t.timestamp),H.set(e,n)}catch(o){se=!1,k.warn("[modelEvaluation] Failed to initialize from IndexedDB. Falling back to memory only.",o)}}function Je(){ve||(ve=!0,We().catch(o=>{k.warn("[modelEvaluation] Initialization load failed",o)}))}async function Ke(o){if(se)try{const e=await Ie();await new Promise((n,t)=>{const i=e.transaction([J],"readwrite").objectStore(J).put(o);i.onsuccess=()=>n(),i.onerror=()=>t(i.error)})}catch(e){k.warn("[modelEvaluation] persistRun failed",e)}}function we(o,e,n){try{return B({namespace:o,input:e,version:n})}catch{try{const t=Te(e);return[o,n?`v${n}`:void 0,t].filter(Boolean).join(":")}catch(t){return k.warn("[modelEvaluation] computeStableSignature failed; returning placeholder",t),`${o}:unknown`}}}function Me(o){if(Je(),!o||!o.id||!o.modelType||!o.timestamp){k.warn("[modelEvaluation] recordEvaluation called with invalid run payload",{hasRun:!!o});return}if(!o.dataSignature){const t=we("model-eval:data",{id:o.id,ts:o.timestamp,mt:o.modelType},o.schemaVersion);o={...o,dataSignature:t}}if(!o.configSignature){const t=we("model-eval:config",{id:o.id,task:o.taskType,mt:o.modelType},o.schemaVersion);o={...o,configSignature:t}}try{const t=qe({modelType:o.modelType,taskType:o.taskType,dataSignature:o.dataSignature,configSignature:o.configSignature,schemaVersion:o.schemaVersion});if(He(t)){k.debug("[modelEvaluation] Skipping redundant evaluation record (cache fresh)",{key:t,ttlMs:Ce});return}const a=[xe,String(o.modelType),String(o.taskType)];Be(t,a)}catch(t){k.warn("[modelEvaluation] eval cache key/touch failed; proceeding without skip",t)}const e=H.get(o.modelType)??[],n=e.findIndex(t=>t.id===o.id);n>=0?e[n]=o:e.push(o),e.sort((t,a)=>a.timestamp-t.timestamp),H.set(o.modelType,e),Ke(o)}class Xe{dbName="sensory-compass-ml";storeName="models";db=null;async init(){if(typeof indexedDB>"u"){console.warn("IndexedDB not available, ML models will not persist");return}return new Promise((e,n)=>{try{const t=indexedDB.open(this.dbName,1);t.onerror=()=>{console.warn("Failed to open IndexedDB:",t.error),e()},t.onsuccess=()=>{this.db=t.result,e()},t.onupgradeneeded=a=>{const s=a.target.result;s.objectStoreNames.contains(this.storeName)||s.createObjectStore(this.storeName,{keyPath:"name"})}}catch(t){console.warn("IndexedDB initialization failed:",t),e()}})}async saveModel(e,n,t){if(this.db||await this.init(),!this.db){console.warn("Cannot save model - IndexedDB not available");return}await n.save($e(async a=>{const i=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName);return await new Promise((r,c)=>{const g=i.put({name:e,artifacts:a,metadata:t,timestamp:new Date});g.onsuccess=()=>r(),g.onerror=()=>c(g.error)}),{modelArtifactsInfo:{dateSaved:new Date,modelTopologyType:"JSON"}}}))}async loadModel(e){return this.db||await this.init(),this.db?new Promise((n,t)=>{const i=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).get(e);i.onsuccess=async()=>{const r=i.result;if(!r){n(null);return}const c=await Le(Ne(r.artifacts));n({model:c,metadata:r.metadata})},i.onerror=()=>t(i.error)}):(console.warn("Cannot load model - IndexedDB not available"),null)}async deleteModel(e){if(this.db||await this.init(),!this.db){console.warn("Cannot delete model - IndexedDB not available");return}return new Promise((n,t)=>{const i=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).delete(e);i.onsuccess=()=>n(),i.onerror=()=>t(i.error)})}async listModels(){return this.db||await this.init(),this.db?new Promise((e,n)=>{const s=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).getAll();s.onsuccess=()=>{const i=s.result.map(r=>r.metadata);e(i)},s.onerror=()=>n(s.error)}):(console.warn("Cannot list models - IndexedDB not available"),[])}}class Qe{storage;models;isInitialized=!1;constructor(){this.storage=new Xe,this.models=new Map}async init(){if(this.isInitialized)return;await this.storage.init();const e=["emotion-prediction","sensory-response","baseline-clustering"];for(const n of e){const t=await this.storage.loadModel(n);t&&this.models.set(n,t)}this.isInitialized=!0}createEmotionModel(){const e=ue({layers:[ge({units:64,returnSequences:!0,inputShape:[7,13]}),te({rate:.2}),ge({units:32,returnSequences:!1}),te({rate:.2}),Y({units:16,activation:"relu"}),Y({units:7,activation:"sigmoid"})]});return e.compile({optimizer:fe.adam(.001),loss:"meanSquaredError",metrics:["mse","mae"]}),e}createSensoryModel(){const e=ue({layers:[Y({units:32,activation:"relu",inputShape:[12]}),te({rate:.2}),Y({units:16,activation:"relu"}),te({rate:.2}),Y({units:15,activation:"softmax"})]});return e.compile({optimizer:fe.adam(.001),loss:"categoricalCrossentropy",metrics:["accuracy"]}),e}async trainEmotionModel(e,n=50,t,a){const s=oe(e),i=this.createEmotionModel(),{inputs:r,outputs:c,meta:g}=ye(s),d=await i.fit(r,c,{epochs:n,batchSize:32,validationSplit:.2,callbacks:t,shuffle:!0});try{const h=T.getConfig(),m=d.history.loss?.[d.history.loss.length-1],w=d.history.val_mse?.[d.history.val_mse.length-1]??d.history.mse?.[d.history.mse.length-1],u=d.history.val_mae?.[d.history.val_mae.length-1]??d.history.mae?.[d.history.mae.length-1],f=B({namespace:"ml-training:data",input:{modelType:"emotion-prediction",dataPoints:e.length,epochs:n,preprocessingSchemaVersion:g?.schemaVersion},version:h.schemaVersion}),p=B({namespace:"ml-training:config",input:{inputShape:[7,13],outputShape:[7],architecture:"LSTM"},version:h.schemaVersion}),M={id:`${Date.now()}-emotion`,modelType:"emotion-prediction",timestamp:Date.now(),dataSignature:f,configSignature:p,taskType:"regression",metrics:{regression:{mse:w,mae:u}},schemaVersion:h.schemaVersion,notes:g?.schemaVersion?`preprocessingSchemaVersion=${g.schemaVersion}`:void 0};Me(M)}catch{}const l={name:"emotion-prediction",version:"1.0.0",createdAt:new Date,lastTrainedAt:new Date,accuracy:d.history.val_mse?d.history.val_mse[d.history.val_mse.length-1]:void 0,loss:d.history.loss[d.history.loss.length-1],inputShape:[7,13],outputShape:[7],architecture:"LSTM",epochs:n,dataPoints:e.length,preprocessingSchemaVersion:g?.schemaVersion};await this.storage.saveModel("emotion-prediction",i,l),this.models.set("emotion-prediction",{model:i,metadata:l}),r.dispose(),c.dispose()}async trainSensoryModel(e,n=50,t,a){const s=oe(e),i=this.createSensoryModel(),{inputs:r,outputs:c,meta:g}=Re(s),d=await i.fit(r,c,{epochs:n,batchSize:32,validationSplit:.2,callbacks:t,shuffle:!0});try{const h=T.getConfig(),m=d.history.loss?.[d.history.loss.length-1],w=d.history.val_accuracy?.[d.history.val_accuracy.length-1]??d.history.accuracy?.[d.history.accuracy.length-1]??d.history.acc?.[d.history.acc.length-1],u=B({namespace:"ml-training:data",input:{modelType:"sensory-response",dataPoints:e.length,epochs:n,preprocessingSchemaVersion:g?.schemaVersion},version:h.schemaVersion}),f=B({namespace:"ml-training:config",input:{inputShape:[12],outputShape:[15],architecture:"Dense"},version:h.schemaVersion}),p={id:`${Date.now()}-sensory`,modelType:"sensory-response",timestamp:Date.now(),dataSignature:u,configSignature:f,taskType:"classification",metrics:{classification:{accuracy:w}},schemaVersion:h.schemaVersion,notes:g?.schemaVersion?`preprocessingSchemaVersion=${g.schemaVersion}`:void 0};Me(p)}catch{}const l={name:"sensory-response",version:"1.0.0",createdAt:new Date,lastTrainedAt:new Date,accuracy:d.history.acc?d.history.acc[d.history.acc.length-1]:void 0,loss:d.history.loss[d.history.loss.length-1],inputShape:[12],outputShape:[15],architecture:"Dense",epochs:n,dataPoints:e.length,preprocessingSchemaVersion:g?.schemaVersion};await this.storage.saveModel("sensory-response",i,l),this.models.set("sensory-response",{model:i,metadata:l}),r.dispose(),c.dispose()}async predictEmotions(e,n=7){const t=oe(e),a=this.models.get("emotion-prediction");if(!a)throw new Error("Emotion prediction model not found");const s=[],i=[...t];for(let r=0;r<n;r++){const{inputs:c,meta:g}=ye(i.slice(-7),7);if(c.shape[0]===0){c.dispose();break}const d=a.model.predict(c.slice([0,0,0],[1,-1,-1])),l=await d.array(),h=new Date(i[i.length-1].date);h.setDate(h.getDate()+1);const m=l[0].map(f=>f*10),w=(()=>{const f=m.reduce((M,y)=>M+y,0)/m.length;return m.reduce((M,y)=>M+Math.pow(y-f,2),0)/m.length})(),u=Math.max(0,Math.min(1,1/(1+w)));s.push({date:h,emotions:{happy:m[0],sad:m[1],angry:m[2],anxious:m[3],calm:m[4],energetic:m[5],frustrated:m[6]},confidence:u,confidenceInterval:{lower:Math.max(0,u-.1),upper:Math.min(1,u+.1)}}),i.push({id:`predicted-${r}`,studentId:i[0].studentId,date:h.toISOString(),emotion:{happy:m[0],sad:m[1],angry:m[2],anxious:m[3],calm:m[4],energetic:m[5],frustrated:m[6]},sensory:i[i.length-1].sensory,environment:i[i.length-1].environment,activities:[],notes:""}),c.dispose(),d.dispose()}return s}async predictSensoryResponse(e,n){const t=this.models.get("sensory-response");if(!t)throw new Error("Sensory response model not found");const a=[e.lighting==="bright"?1:e.lighting==="dim"?.5:0,e.noise==="loud"?1:e.noise==="moderate"?.5:0,e.temperature==="hot"?1:e.temperature==="cold"?0:.5,e.crowded==="very"?1:e.crowded==="moderate"?.5:0,e.smells?1:0,e.textures?1:0],s=me(n),i=ne([[...a,...s]]),r=t.model.predict(i),c=await r.array(),g=["visual","auditory","tactile","vestibular","proprioceptive"],d={visual:{seeking:0,avoiding:0,neutral:0},auditory:{seeking:0,avoiding:0,neutral:0},tactile:{seeking:0,avoiding:0,neutral:0},vestibular:{seeking:0,avoiding:0,neutral:0},proprioceptive:{seeking:0,avoiding:0,neutral:0}};g.forEach((y,v)=>{const b=v*3;d[y]={seeking:c[0][b],avoiding:c[0][b+1],neutral:c[0][b+2]}});const l=[],m=T.getConfig().patternAnalysis.concernFrequencyThreshold;e.noise==="loud"&&d.auditory.avoiding>m&&l.push({trigger:"Loud noise",probability:d.auditory.avoiding}),e.lighting==="bright"&&d.visual.avoiding>m&&l.push({trigger:"Bright lights",probability:d.visual.avoiding}),e.crowded==="very"&&d.tactile.avoiding>m&&l.push({trigger:"Crowded spaces",probability:d.tactile.avoiding}),i.dispose(),r.dispose();const w=c[0],u=Math.max(...w),p=-w.reduce((y,v)=>y+(v>0?v*Math.log(v):0),0)/Math.log(w.length||1),M=Math.max(0,Math.min(1,u*.6+(1-p)*.4));return{sensoryResponse:d,environmentalTriggers:l.sort((y,v)=>v.probability-y.probability),confidence:M}}async getModelStatus(){const e=new Map,n=["emotion-prediction","sensory-response","baseline-clustering"];for(const t of n){const a=this.models.get(t);e.set(t,a?.metadata||null)}return e}async deleteModel(e){await this.storage.deleteModel(e),this.models.delete(e)}async exportModel(e,n){const t=this.models.get(e);if(!t)throw new Error(`Model ${e} not found`);await t.model.save(`file://${n}`)}async performBaselineClustering(e,n=3){if(e.length<n)throw new Error("Not enough data points for clustering");const t=e.map(c=>{const g=c.emotions.length>0?c.emotions.reduce((u,f)=>u+f.intensity,0)/c.emotions.length:0,d=T.getConfig(),l=new Set((d.taxonomy?.positiveEmotions||[]).map(u=>u.toLowerCase())),h=c.emotions.length>0?c.emotions.filter(u=>l.has(u.emotion.toLowerCase())).length/c.emotions.length:0,m=c.sensoryInputs.length>0?c.sensoryInputs.filter(u=>u.response.toLowerCase().includes("seeking")).length/c.sensoryInputs.length:0,w=c.sensoryInputs.length>0?c.sensoryInputs.filter(u=>u.response.toLowerCase().includes("avoiding")).length/c.sensoryInputs.length:0;return[g/5,h,m,w]}),a=this.normalizeFeatures(t),{centroids:s,assignments:i}=await this.kMeansClustering(a,n),r=[];for(let c=0;c<n;c++){const g=a.filter((h,m)=>i[m]===c),d=g.length>0?g.reduce((h,m)=>h+this.euclideanDistance(m,s[c]),0)/g.length:0,l=this.describeCluster(s[c]);r.push({clusterId:c,centroid:s[c],description:l,anomalyScore:d,isNormal:d<.5})}return r}async kMeansClustering(e,n,t=100){const a=e.length,s=e[0].length,i=this.initializeCentroids(e,n),r=new Array(a).fill(0);let c=new Array(a).fill(-1);for(let g=0;g<t;g++){for(let d=0;d<a;d++){let l=1/0,h=0;for(let m=0;m<n;m++){const w=this.euclideanDistance(e[d],i[m]);w<l&&(l=w,h=m)}r[d]=h}if(r.every((d,l)=>d===c[l]))break;c=[...r];for(let d=0;d<n;d++){const l=e.filter((h,m)=>r[m]===d);l.length>0&&(i[d]=new Array(s).fill(0).map((h,m)=>l.reduce((w,u)=>w+u[m],0)/l.length))}}return{centroids:i,assignments:r}}initializeCentroids(e,n){const t=[],a=e.length;t.push([...e[Math.floor(Math.random()*a)]]);for(let s=1;s<n;s++){const i=e.map(d=>{const l=t.reduce((h,m)=>Math.min(h,this.euclideanDistance(d,m)),1/0);return l*l}),r=i.reduce((d,l)=>d+l,0);let c=Math.random()*r,g=0;for(let d=0;d<a;d++)if(c-=i[d],c<=0){g=d;break}t.push([...e[g]])}return t}euclideanDistance(e,n){return Math.sqrt(e.reduce((t,a,s)=>t+Math.pow(a-n[s],2),0))}normalizeFeatures(e){const n=e[0].length,t=new Array(n).fill(1/0),a=new Array(n).fill(-1/0);return e.forEach(s=>{s.forEach((i,r)=>{t[r]=Math.min(t[r],i),a[r]=Math.max(a[r],i)})}),e.map(s=>s.map((i,r)=>{const c=a[r]-t[r];return c===0?0:(i-t[r])/c}))}describeCluster(e){const[n,t,a,s]=e,i=T.getConfig(),r=Math.min(1,i.patternAnalysis.highIntensityThreshold/5),c=Math.max(0,(i.patternAnalysis.highIntensityThreshold-2)/5),g=i.insights.POSITIVE_EMOTION_TREND_THRESHOLD,d=i.insights.NEGATIVE_EMOTION_TREND_THRESHOLD,l=i.patternAnalysis.concernFrequencyThreshold;let h="";return n>r?h+="High emotional intensity":n<c?h+="Low emotional intensity":h+="Moderate emotional intensity",t>g?h+=", predominantly positive emotions":t<d?h+=", predominantly challenging emotions":h+=", mixed emotional states",a>l?h+=", high sensory seeking":s>l?h+=", high sensory avoiding":h+=", balanced sensory responses",h}}const q=new Qe;function K(o){if(!Array.isArray(o))return[];const e=[];for(let n=0;n<o.length;n++){const t=o[n];typeof t=="number"&&Number.isFinite(t)&&e.push(t)}return e}function De(o){if(o.length===0)return 0;let e=0;for(let n=0;n<o.length;n++)e+=o[n];return e}function Z(o){const e=K(o);return e.length===0?0:De(e)/e.length}function Ye(o,e=!0){const n=K(o),t=n.length;if(t===0||t===1)return 0;const a=Z(n);let s=0;for(let r=0;r<t;r++){const c=n[r]-a;s+=c*c}const i=e?t-1:t;return i<=0?0:s/i}function Ae(o,e,n){return Number.isFinite(o)?Math.min(Math.max(o,e),n):o>0?n:e}function le(o){const e=[.9999999999998099,676.5203681218851,-1259.1392167224028,771.3234287776531,-176.6150291621406,12.507343278686905,-.13857109526572012,9984369578019572e-21,15056327351493116e-23];if(o<.5)return Math.log(Math.PI)-Math.log(Math.sin(Math.PI*o))-le(1-o);o-=1;let n=e[0];for(let a=1;a<e.length;a++)n+=e[a]/(o+a);const t=o+e.length-.5;return .5*Math.log(2*Math.PI)+(o+.5)*Math.log(t)-t+Math.log(n)}function W(o){const e=K(o).slice(),n=e.length;if(n===0)return 0;e.sort((a,s)=>a-s);const t=Math.floor(n/2);return n%2===1?e[t]:(e[t-1]+e[t])/2}function Ze(o,e="normal"){const n=K(o);if(n.length===0)return 0;const t=W(n),a=n.map(i=>Math.abs(i-t)),s=W(a);return s===0?0:e==="normal"?1.4826*s:s}function be(o,e){const n=o.slice();if(n.length===0)return[];const t=W(K(n)),a=1.4826,s=K(n);let i=0;if(s.length>0){const c=W(s),g=s.map(l=>Math.abs(l-c));i=W(g)*a}if(!i||i===0)return new Array(n.length).fill(0);const r=new Array(n.length);for(let c=0;c<n.length;c++){const g=n[c];r[c]=Number.isFinite(g)?(g-t)/i:0}return r}function et(o,e){const n=Math.min(o.length,e.length),t=[],a=[];for(let l=0;l<n;l++){const h=o[l],m=e[l];Number.isFinite(h)&&Number.isFinite(m)&&(t.push(h),a.push(m))}const s=t.length;if(s<2)return 0;const i=Z(t),r=Z(a);let c=0,g=0,d=0;for(let l=0;l<s;l++){const h=t[l]-i,m=a[l]-r;c+=h*m,g+=h*h,d+=m*m}return g<=0||d<=0?0:c/Math.sqrt(g*d)}function tt(o,e){if(!Number.isFinite(o))return NaN;if(!Number.isFinite(e)||e<=0)return .5;const n=Math.abs(o),t=Math.exp(le((e+1)/2)-le(e/2)-.5*Math.log(e*Math.PI)),a=m=>t*Math.pow(1+m*m/e,-((e+1)/2));function s(m,w,u){const f=(w+u)/2;return(u-w)/6*(m(w)+4*m(f)+m(u))}function i(m,w,u,f,p,M){const y=(w+u)/2,v=s(m,w,y),b=s(m,y,u),S=v+b-p;return M<=0||Math.abs(S)<=15*f?v+b+S/15:i(m,w,y,f/2,v,M-1)+i(m,y,u,f/2,b,M-1)}const r=1e-12,c=30,g=s(a,0,n),d=n===0?0:i(a,0,n,r,g,c),l=.5,h=o>=0?l+d:l-d;return Ae(h,0,1)}function nt(o,e){if(!Number.isFinite(o)||!Number.isFinite(e)||e<3)return 1;const n=e-2,t=1-o*o;if(t<=0)return 0;const a=Math.abs(o*Math.sqrt(n)/Math.sqrt(t));let i=2*(1-tt(a,n));return Number.isFinite(i)||(i=1),Ae(Math.max(i,1e-16),0,1)}function st(o,e,n){const t=Math.min(o.length,e.length),a=[],s=[];for(let v=0;v<t;v++){const b=o[v],S=e[v];Number.isFinite(b)&&Number.isFinite(S)&&(a.push(b),s.push(S))}const i=a.length,r=i>0?W(s):0;if(i<2)return{slope:0,intercept:r,iterations:0,converged:!1,weights:new Array(t).fill(0)};const c=typeof n?.delta=="number"&&n.delta>0?n.delta:1.345,g=typeof n?.maxIter=="number"&&n.maxIter>0?Math.floor(n.maxIter):50,d=typeof n?.tol=="number"&&n.tol>0?n.tol:1e-6,l=Z(a),h=Z(s);let m=0,w=0;for(let v=0;v<i;v++){const b=a[v]-l;m+=b*(s[v]-h),w+=b*b}let u=w>0?m/w:0,f=h-u*l;const p=new Array(i).fill(1);let M=!1,y=0;for(let v=0;v<g;v++){y=v+1;const b=new Array(i);for(let x=0;x<i;x++)b[x]=s[x]-(f+u*a[x]);let S=Ze(b,"normal");if(!S||S===0){const x=Ye(b,!0);S=Math.sqrt(Math.max(x,1e-12))}for(let x=0;x<i;x++){const F=b[x],C=Math.abs(F),P=c*S;p[x]=C<=P?1:P/C}const I=De(p);if(I<=0)break;let D=0,A=0;for(let x=0;x<i;x++){const F=p[x];D+=F*a[x],A+=F*s[x]}const E=D/I,$=A/I;let L=0,N=0;for(let x=0;x<i;x++){const F=p[x],C=a[x]-E;L+=F*C*C,N+=F*C*(s[x]-$)}const X=u,Q=f;L>0&&(u=N/L),f=$-u*E;const j=Math.abs(u-X),ee=Math.abs(f-Q);if(j<d&&ee<d){M=!0;break}}return{slope:u,intercept:f,iterations:y,converged:M,weights:p}}class it{mlModelsInitialized=!1;constructor(){this.initializeMLModels()}async initializeMLModels(){try{await q.init(),this.mlModelsInitialized=!0}catch(e){k.error("Failed to initialize ML models:",e),this.mlModelsInitialized=!1}}async generatePredictiveInsights(e,n,t,a=[]){const s=T,i=typeof s.get=="function"?s.get():T.getConfig(),{enhancedAnalysis:r,timeWindows:c,alertSensitivity:g,analytics:d,insights:l,taxonomy:h,patternAnalysis:m}=i,w=[],u=this.analyzeEmotionTrend(e);if(u&&u.significance>=r.predictionConfidenceThreshold){const M={type:"prediction",title:"Emotional Well-being Forecast (Statistical)",description:`Based on current trends, emotional intensity is ${u.direction}`,confidence:u.significance,timeframe:"7-day forecast",prediction:{value:u.forecast.next7Days,trend:u.direction,accuracy:u.confidence},recommendations:this.getEmotionTrendRecommendations(u),severity:this.getTrendSeverity(u),source:"statistical"};w.push(M)}if(this.mlModelsInitialized&&t.length>=7)try{if((await q.getModelStatus()).get("emotion-prediction")){const y=await q.predictEmotions(t.slice(-14),7);if(y.length>0){const v=y.reduce((L,N)=>{const X=Object.values(N.emotions).reduce((Q,j)=>Q+j,0);return L+X/Object.keys(N.emotions).length},0)/y.length,b=e.slice(-7).reduce((L,N)=>L+N.intensity,0)/Math.max(e.slice(-7).length,1),S=1+r.trendThreshold,I=1-r.trendThreshold,D=v>=b*S?"increasing":v<=b*I?"decreasing":"stable",A=m.highIntensityThreshold,E=Math.max(A-2,1),$=v>=A?"high":v<=E?"medium":"low";w.push({type:"prediction",title:"Emotional Well-being Forecast (ML)",description:`Machine learning predicts emotional patterns will be ${D}`,confidence:y[0].confidence,timeframe:"7-day forecast",prediction:{value:v,trend:D,accuracy:y[0].confidence},recommendations:this.getMLEmotionRecommendations(y,D),severity:$,source:"ml",mlPrediction:y})}}}catch(M){k.error("ML emotion prediction failed:",M)}const f=this.analyzeSensoryTrend(n);if(f&&f.significance>=r.predictionConfidenceThreshold&&w.push({type:"prediction",title:"Sensory Regulation Forecast (Statistical)",description:`Sensory seeking/avoiding patterns show ${f.direction} trend`,confidence:f.significance,timeframe:"14-day forecast",prediction:{value:f.forecast.next7Days,trend:f.direction,accuracy:f.confidence},recommendations:this.getSensoryTrendRecommendations(f),severity:this.getTrendSeverity(f),source:"statistical"}),this.mlModelsInitialized&&t.length>0)try{if((await q.getModelStatus()).get("sensory-response")&&t[t.length-1].environmentalData){const y={lighting:t[t.length-1].environmentalData?.roomConditions?.lighting||"moderate",noise:t[t.length-1].environmentalData?.roomConditions?.noiseLevel&&t[t.length-1].environmentalData.roomConditions.noiseLevel>70?"loud":t[t.length-1].environmentalData?.roomConditions?.noiseLevel&&t[t.length-1].environmentalData.roomConditions.noiseLevel<40?"quiet":"moderate",temperature:t[t.length-1].environmentalData?.roomConditions?.temperature&&t[t.length-1].environmentalData.roomConditions.temperature>26?"hot":t[t.length-1].environmentalData?.roomConditions?.temperature&&t[t.length-1].environmentalData.roomConditions.temperature<18?"cold":"comfortable",crowded:"moderate",smells:!1,textures:!1},v=await q.predictSensoryResponse(y,new Date);v&&w.push({type:"prediction",title:"Sensory Response Prediction (ML)",description:"Machine learning predicts sensory responses based on current environment",confidence:v.confidence,timeframe:"Current environment",recommendations:this.getMLSensoryRecommendations(v),severity:v.environmentalTriggers.length>2?"high":v.environmentalTriggers.length>0?"medium":"low",source:"ml",mlPrediction:v})}}catch(M){k.error("ML sensory prediction failed:",M)}a.forEach(M=>{const y=this.predictGoalAchievement(M);y&&w.push(y)});const p=this.assessRisks(e,n,t);return w.push(...p),w}analyzeTrendsWithStatistics(e){const n=T,t=typeof n.get=="function"?n.get():T.getConfig(),{enhancedAnalysis:a,analytics:s,timeWindows:i}=t;if(e.length<a.minSampleSize)return null;const r=[...e].sort((C,P)=>C.timestamp.getTime()-P.timestamp.getTime()),c=r.length,g=r.map((C,P)=>P),d=r.map(C=>C.value),l=a?.huber||{delta:1.345,maxIter:50,tol:1e-6},{slope:h,intercept:m}=st(g,d,{maxIter:Number.isFinite(l.maxIter)?l.maxIter:50,tol:Number.isFinite(l.tol)?l.tol:1e-6,delta:Number.isFinite(l.delta)?l.delta:1.345}),w=Number.isFinite(m)?m:0,u=[],f=[];for(let C=0;C<c;C++){const P=d[C];Number.isFinite(P)&&(u.push(g[C]),f.push(P))}const p=u.length,M=new Array(c);for(let C=0;C<c;C++){const P=g[C],_=Number.isFinite(h)?h*P+w:w;M[C]=Number.isFinite(_)?_:0}let y=0;if(p>=2){const C=f.reduce((V,ie)=>V+ie,0)/p;let P=0,_=0;for(let V=0;V<p;V++){const ie=u[V],de=f[V]-M[ie];P+=de*de;const he=f[V]-C;_+=he*he}y=_===0?0:Math.max(0,Math.min(1,1-P/_))}const v=Ee(r[r.length-1].timestamp,r[0].timestamp),b=Math.max(1,v||0),S=Number.isFinite(h)?h*(c/b):0,I=Number(a?.qualityTargets?.pointsTarget),D=Number(a?.qualityTargets?.timeSpanDaysTarget),A=Number.isFinite(I)&&I>0?Math.min(1,c/I):0,E=Number.isFinite(D)&&D>0?Math.min(1,v/D):0,$=Math.max(0,y),L=A*.3+E*.3+$*.4,N=Number.isFinite(L)?L:0,X=Number(a?.trendThreshold)||0,Q=Math.abs(S)<X?"stable":S>0?"increasing":"decreasing",j=M[M.length-1]??0,ee=Number.isFinite(h)?h:0,x=j+ee*(Number(i?.recentDataDays)||7),F=j+ee*(Number(i?.defaultAnalysisDays)||30);return{metric:"Overall Trend",direction:Q,rate:Number.isFinite(S)?S:0,significance:Number.isFinite(y)?y:0,confidence:N,forecast:{next7Days:Number.isFinite(x)?x:0,next30Days:Number.isFinite(F)?F:0,confidence:N}}}generateConfidenceExplanation(e,n,t,a){const s=T,i=typeof s.get=="function"?s.get():T.getConfig(),{enhancedAnalysis:r,timeWindows:c,insights:g,patternAnalysis:d}=i||{},l=[];let h="",m="low";if(typeof r?.minSampleSize=="number"&&(e<r.minSampleSize?l.push(`insufficientData:${e}:${r.minSampleSize}`):l.push(`sufficientData:${e}:${r.minSampleSize}`)),typeof c?.shortTermDays=="number"){const u=typeof c?.defaultAnalysisDays=="number"?c.defaultAnalysisDays:void 0;n<c.shortTermDays?l.push(u!=null?`shortTimespan:${n}:${u}`:`shortTimespan:${n}`):l.push(u!=null?`adequateTimespan:${n}:${u}`:`adequateTimespan:${n}`)}const w=r?.correlationSignificance;if(w&&typeof w.low=="number"&&typeof w.moderate=="number"&&typeof w.high=="number")t<w.low?l.push(`weakPattern:${t.toFixed(3)}:low=${w.low}`):t>=w.high?l.push(`strongPattern:${t.toFixed(3)}:high=${w.high}`):t>=w.moderate?l.push(`moderatePattern:${t.toFixed(3)}:moderate=${w.moderate}`):l.push(`lowPattern:${t.toFixed(3)}:low=${w.low}`);else if(typeof d?.correlationThreshold=="number"){const u=d.correlationThreshold,f=Math.max(.7,u+.4);t<u?l.push(`weakPattern:${t.toFixed(3)}:ct=${u}`):t>f?l.push(`strongPattern:${t.toFixed(3)}:ct=${u}`):l.push(`moderatePattern:ct=${u}`)}else l.push("moderatePattern");if(typeof g?.HIGH_CONFIDENCE_PATTERN_THRESHOLD=="number"){const u=g.HIGH_CONFIDENCE_PATTERN_THRESHOLD,f=u-.2;if(a>=u)if(m="high",typeof d?.correlationThreshold=="number"){const p=d.correlationThreshold,M=Math.max(.7,p+.4);h=t>M?"excellentData":"reliableInsight"}else h="reliableInsight";else a>=f?(m="medium",h="emergingTrend"):(m="low",h="needMoreData")}else m="low",h="needMoreData";return{level:m,explanation:h,factors:l}}detectAnomalies(e,n,t){const a=T,s=typeof a.get=="function"?a.get():T.getConfig(),{enhancedAnalysis:i,alertSensitivity:r}=s,c=[],g=e.map(u=>u.intensity),d=i.anomalyThreshold*r.anomalyMultiplier,l=i.anomalySeverityLevels||{medium:2.5,high:3},h=be(g);e.forEach((u,f)=>{const p=Math.abs(h[f]??0);if(p>d){const M=p>=l.high?"high":p>=l.medium?"medium":"low";c.push({timestamp:u.timestamp,type:"emotion",severity:M,description:`Unusual ${u.emotion} intensity detected (${u.intensity}/5)`,deviationScore:p,recommendations:this.getAnomalyRecommendations("emotion",u.emotion,p)})}});const m=this.groupSensoryByDay(n),w=Object.values(m);if(w.length>0){const u=be(w);Object.keys(m).forEach((p,M)=>{const y=m[p],v=Math.abs(u[M]??0);if(v>d){const b=v>=l.high?"high":v>=l.medium?"medium":"low";c.push({timestamp:new Date(p),type:"sensory",severity:b,description:`Unusual sensory activity level detected (${y} inputs)`,deviationScore:v,recommendations:this.getAnomalyRecommendations("sensory","frequency",v)})}})}return c.sort((u,f)=>f.timestamp.getTime()-u.timestamp.getTime())}generateCorrelationMatrix(e){const n=T,t=typeof n.get=="function"?n.get():T.getConfig(),{enhancedAnalysis:a,patternAnalysis:s,taxonomy:i}=t,r=["avgEmotionIntensity","positiveEmotionRatio","sensorySeekingRatio","noiseLevel","temperature","lightingQuality"],c=new Set((i?.positiveEmotions||[]).map(f=>f.toLowerCase())),g=e.map(f=>({avgEmotionIntensity:f.emotions.length>0?f.emotions.reduce((p,M)=>p+M.intensity,0)/f.emotions.length:0,positiveEmotionRatio:f.emotions.length>0?f.emotions.filter(p=>c.has(p.emotion.toLowerCase())).length/f.emotions.length:0,sensorySeekingRatio:f.sensoryInputs.length>0?f.sensoryInputs.filter(p=>p.response.toLowerCase().includes("seeking")).length/f.sensoryInputs.length:0,noiseLevel:f.environmentalData?.roomConditions?.noiseLevel||0,temperature:f.environmentalData?.roomConditions?.temperature||0,lightingQuality:this.convertLightingToNumeric(f.environmentalData?.roomConditions?.lighting)})),d=[],l=[],h=a?.correlationSignificance,m=Math.max(0,Math.min(1,h?.low??s.correlationThreshold??.3)),w=Math.max(m,Math.min(1,h?.moderate??m+.2)),u=Math.max(w,Math.min(1,h?.high??m+.4));return r.forEach((f,p)=>{d[p]=[],r.forEach((M,y)=>{const v=[],b=[];for(let D=0;D<g.length;D++){const A=g[D],E=A[f],$=A[M];typeof E=="number"&&Number.isFinite(E)&&typeof $=="number"&&Number.isFinite($)&&(v.push(E),b.push($))}const S=v.length,I=et(v,b);if(d[p][y]=I,p<y&&Math.abs(I)>=m&&S>=a.minSampleSize){const D=nt(I,S),A=Math.abs(I),E=A>=u?"high":A>=w?"moderate":"low";l.push({factor1:f,factor2:M,correlation:I,pValue:D,significance:E})}})}),{factors:r,matrix:d,significantPairs:l.sort((f,p)=>Math.abs(p.correlation)-Math.abs(f.correlation))}}analyzeEmotionTrend(e){const n=e.map(t=>({value:t.intensity,timestamp:t.timestamp}));return this.analyzeTrendsWithStatistics(n)}analyzeSensoryTrend(e){const n=e.map(t=>({value:t.response.toLowerCase().includes("seeking")?1:t.response.toLowerCase().includes("avoiding")?-1:0,timestamp:t.timestamp}));return this.analyzeTrendsWithStatistics(n)}predictGoalAchievement(e){if(!e.dataPoints||e.dataPoints.length<3)return null;const n=e.dataPoints.map(c=>({value:c.value,timestamp:c.timestamp})),t=this.analyzeTrendsWithStatistics(n);if(!t)return null;const a=e.dataPoints[e.dataPoints.length-1].value,s=e.targetValue,i=s-a,r=t.rate>0?i/t.rate:-1;return{type:"prediction",title:`Goal Achievement Forecast: ${e.title}`,description:r>0?`Estimated ${Math.ceil(r)} days to achieve goal at current pace`:"Goal may require strategy adjustment based on current trend",confidence:t.significance,timeframe:"Goal completion forecast",prediction:{value:s,trend:t.direction,accuracy:t.significance},recommendations:this.getGoalRecommendations(e,t,r),severity:r<0?"high":r>60?"medium":"low"}}assessRisks(e,n,t){const a=T,s=typeof a.get=="function"?a.get():T.getConfig(),{timeWindows:i,enhancedAnalysis:r,alertSensitivity:c}=s,g=[],d={emotions:e.filter(f=>f.timestamp>=U(new Date,i.shortTermDays)),sensoryInputs:n.filter(f=>f.timestamp>=U(new Date,i.shortTermDays)),trackingEntries:t.filter(f=>f.timestamp>=U(new Date,i.shortTermDays))},l=Math.max(1,Math.floor(r?.riskAssessmentThreshold??3)),h=s?.enhancedAnalysis?.riskAssessment?.stressIntensityThreshold,m=s?.enhancedAnalysis?.riskAssessment?.stressEmotions,w=Array.isArray(m)?m.map(f=>f.toLowerCase()):[];let u=0;return typeof h=="number"&&w.length>0&&(u=d.emotions.filter(f=>f.intensity>=h&&w.includes(f.emotion.toLowerCase())).length),u>=l&&u>0&&g.push({type:"risk",title:"Stress Accumulation Risk",description:`${u} high-stress incidents in the past 2 weeks`,confidence:.8,timeframe:"Immediate attention needed",recommendations:["Implement immediate stress reduction strategies","Review and adjust current interventions","Consider environmental modifications","Schedule additional support sessions"],severity:"high"}),g}groupSensoryByDay(e){return e.reduce((n,t)=>{const a=Pe(t.timestamp,"yyyy-MM-dd");return n[a]=(n[a]||0)+1,n},{})}convertLightingToNumeric(e){return{dim:1,normal:2,bright:3,fluorescent:2.5,natural:3.5}[e?.toLowerCase()||""]||2}getEmotionTrendRecommendations(e){return e.direction==="decreasing"?["Increase positive reinforcement strategies","Review environmental factors that may be contributing to stress","Consider additional sensory support tools","Schedule more frequent check-ins"]:e.direction==="increasing"?["Continue current successful strategies","Document what is working well","Gradually introduce new challenges","Share progress with student and family"]:["Monitor for changes in patterns","Maintain current support level","Be prepared to adjust strategies as needed"]}getSensoryTrendRecommendations(e){return e.rate>0?["Provide more structured sensory breaks","Introduce additional sensory tools","Consider sensory diet adjustments","Monitor for overstimulation"]:e.rate<0?["Reduce environmental stimuli","Provide more quiet spaces","Gradually reintroduce sensory experiences","Focus on calming strategies"]:["Maintain current sensory support level","Continue monitoring sensory preferences","Be responsive to daily variations"]}getGoalRecommendations(e,n,t){return t<0?["Review and adjust goal strategies","Break goal into smaller milestones","Identify and address barriers","Consider modifying timeline or approach"]:t>90?["Increase intervention frequency","Add additional support strategies","Review goal expectations","Provide more immediate reinforcement"]:["Continue current approach","Monitor progress regularly","Celebrate milestones reached","Maintain consistent support"]}getAnomalyRecommendations(e,n,t){return e==="emotion"?["Investigate potential triggers for this emotional spike","Provide immediate support and coping strategies","Monitor closely for additional unusual patterns","Consider environmental or schedule changes"]:e==="sensory"?["Review sensory environment for unusual factors","Check for changes in routine or schedule","Provide additional sensory regulation support","Monitor for illness or other physical factors"]:["Investigate potential causes","Provide additional support","Monitor closely","Document and track patterns"]}getTrendSeverity(e){const n=T,a=(typeof n.get=="function"?n.get():T.getConfig())?.enhancedAnalysis?.correlationSignificance,s=typeof a?.high=="number"?a.high:.7,i=typeof a?.moderate=="number"?a.moderate:.5;return e.direction==="decreasing"&&e.significance>=s?"high":e.direction==="decreasing"&&e.significance>=i?"medium":"low"}getMLEmotionRecommendations(e,n){const t=e.filter(i=>i.emotions.anxious>7).length,a=e.filter(i=>i.emotions.happy<3&&i.emotions.calm<3).length,s=[];return t>=3&&(s.push("ML predicts elevated anxiety - implement proactive calming strategies"),s.push("Schedule additional check-ins on high-anxiety days")),a>=4&&(s.push("ML indicates low positive emotions upcoming - increase engagement activities"),s.push("Prepare mood-boosting interventions")),n==="increasing"?s.push("ML shows increasing emotional intensity - monitor for triggers"):n==="decreasing"&&s.push("ML shows decreasing emotional engagement - check for withdrawal signs"),s.push("Compare ML predictions with actual outcomes to refine models"),s}getMLSensoryRecommendations(e){const n=[],t=T,s=(typeof t.get=="function"?t.get():T.getConfig())?.enhancedAnalysis?.correlationSignificance,i=typeof s?.high=="number"?s.high:.7;return Object.entries(e.sensoryResponse).forEach(([r,c])=>{c.avoiding>i?n.push(`High ${r} avoidance predicted - minimize ${r} stimuli`):c.seeking>i&&n.push(`High ${r} seeking predicted - provide ${r} input opportunities`)}),e.environmentalTriggers.forEach(r=>{r.probability>i&&n.push(`High probability of reaction to ${r.trigger} - prepare alternatives`)}),n}async analyzeBaseline(e){const n=T,t=typeof n.get=="function"?n.get():T.getConfig(),{enhancedAnalysis:a,patternAnalysis:s,timeWindows:i,alertSensitivity:r,analytics:c,insights:g,taxonomy:d}=t;if(!this.mlModelsInitialized||e.length<10)return[];try{return await q.performBaselineClustering(e,3)}catch(l){return k.error("Baseline clustering failed:",l),[]}}}const ft=new it;export{B as c,ft as e,q as m,gt as p};
